(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class N{constructor(t,e,s){this.width=t,this.height=e,this.cellSize=s,this.cols=Math.floor(t/s),this.rows=Math.floor(e/s),this.cells=new Int8Array(this.cols*this.rows),this.colors={1:"#00ffff",2:"#ff00ff"}}_getIndex(t,e){return e*this.cols+t}paintRadius(t,e,s,i){const a=Math.max(0,Math.floor((t-s)/this.cellSize)),r=Math.max(0,Math.floor((e-s)/this.cellSize)),n=Math.min(this.cols-1,Math.floor((t+s)/this.cellSize)),l=Math.min(this.rows-1,Math.floor((e+s)/this.cellSize)),o=s*s;for(let c=r;c<=l;c++)for(let u=a;u<=n;u++){const p=u*this.cellSize+this.cellSize/2,m=c*this.cellSize+this.cellSize/2,g=p-t,w=m-e;g*g+w*w<=o&&(this.cells[this._getIndex(u,c)]=i)}}clearRadius(t,e,s){const i=Math.max(0,Math.floor((t-s)/this.cellSize)),a=Math.max(0,Math.floor((e-s)/this.cellSize)),r=Math.min(this.cols-1,Math.floor((t+s)/this.cellSize)),n=Math.min(this.rows-1,Math.floor((e+s)/this.cellSize)),l=s*s;for(let o=a;o<=n;o++)for(let c=i;c<=r;c++){const u=c*this.cellSize+this.cellSize/2,p=o*this.cellSize+this.cellSize/2,m=u-t,g=p-e;m*m+g*g<=l&&(this.cells[this._getIndex(c,o)]=0)}}getDomination(t){let e=0;const s=this.cols*this.rows;for(let i=0;i<s;i++)this.cells[i]===t&&e++;return e/s*100}draw(t,e,s,i,a){t.save(),t.translate(-e,-s);const r=Math.max(0,Math.floor(e/this.cellSize)),n=Math.max(0,Math.floor(s/this.cellSize)),l=Math.min(this.cols,Math.ceil((e+i)/this.cellSize)),o=Math.min(this.rows,Math.ceil((s+a)/this.cellSize));t.strokeStyle="rgba(255, 255, 255, 0.05)",t.lineWidth=1,t.beginPath();for(let c=r*this.cellSize;c<=l*this.cellSize;c+=this.cellSize)t.moveTo(c,n*this.cellSize),t.lineTo(c,o*this.cellSize);for(let c=n*this.cellSize;c<=o*this.cellSize;c+=this.cellSize)t.moveTo(r*this.cellSize,c),t.lineTo(l*this.cellSize,c);t.stroke(),t.globalAlpha=.3,t.fillStyle=this.colors[1],t.beginPath();for(let c=n;c<o;c++)for(let u=r;u<l;u++)this.cells[this._getIndex(u,c)]===1&&t.rect(u*this.cellSize,c*this.cellSize,this.cellSize,this.cellSize);t.fill(),t.fillStyle=this.colors[2],t.beginPath();for(let c=n;c<o;c++)for(let u=r;u<l;u++)this.cells[this._getIndex(u,c)]>=2&&t.rect(u*this.cellSize,c*this.cellSize,this.cellSize,this.cellSize);t.fill(),t.strokeStyle="#ff0055",t.lineWidth=5,t.globalAlpha=1,t.strokeRect(0,0,this.width,this.height),t.restore()}}const D="voidRushData",A=2,_=500;class d{addMatchResult(t,e){return d.addMatchResult(t,e)}static getDefaultData(){return{schemaVersion:A,level:1,exp:0,credits:2e3,gems:500,unlockedCharacters:[1],selectedCharacterId:1,upgrades:{hp:0,speed:0,magnet:0},loginBonus:{lastLoginDate:"",streak:0},missions:{daily:[],lastResetDate:""},stats:{totalMatches:0,totalKills:0,totalNodesCaptured:0,bestDomination:0,bestKills:0,winCount:0},characterData:{},pityCounter:0,battlePass:{level:0,exp:0,claimed:[]},tutorialDone:!1,notifications:{unclaimedMissions:0,loginBonusPending:!1},economyLedger:[]}}static get(){const t=this.getDefaultData(),e=localStorage.getItem(D);if(!e)return t;let s;try{s=JSON.parse(e)}catch(r){return console.error("Save data corrupted. Resetting to defaults.",r),t}const i={...t,...s};i.stats={...t.stats,...s.stats||{}},i.loginBonus={...t.loginBonus,...s.loginBonus||{}},i.missions={...t.missions,...s.missions||{}},i.battlePass={...t.battlePass,...s.battlePass||{}},i.notifications={...t.notifications,...s.notifications||{}},i.characterData=s.characterData||{},i.economyLedger=Array.isArray(s.economyLedger)?s.economyLedger:[];const a=this.migrateSaveData(i);return a.changed&&localStorage.setItem(D,JSON.stringify(a.data)),a.data}static save(t){localStorage.setItem(D,JSON.stringify(t))}static getLevel(){return this.get().level}static getCredits(){return this.get().credits}static getGems(){return this.get().gems}static getUnlockedCharacters(){return this.get().unlockedCharacters}static getSelectedCharacter(){return this.get().selectedCharacterId}static getUpgrades(){return this.get().upgrades}static getLoginBonus(){return this.get().loginBonus}static getMissions(){return this.get().missions}static getStats(){return this.get().stats}static getPityCounter(){return this.get().pityCounter}static getBattlePass(){return this.get().battlePass}static isTutorialDone(){return this.get().tutorialDone}static hasCharacter(t){return this.get().unlockedCharacters.includes(t)}static addCredits(t,e="unknown",s={}){let i=this.get();const a=i.credits;i.credits=Math.max(0,i.credits+t);const r=i.credits-a;r!==0&&this.appendEconomyLog(i,{category:"credits",source:e,amount:r,before:a,after:i.credits,meta:s}),this.save(i)}static addGems(t,e="unknown",s={}){let i=this.get();const a=i.gems;i.gems=Math.max(0,i.gems+t);const r=i.gems-a;r!==0&&this.appendEconomyLog(i,{category:"gems",source:e,amount:r,before:a,after:i.gems,meta:s}),this.save(i)}static addExp(t,e="unknown",s={}){let i=this.get();const a=i.exp;i.exp+=t;let r=i.level*1e3;for(;i.exp>=r;)i.level++,i.exp-=r,r=i.level*1e3;(i.exp-a!==0||t!==0)&&this.appendEconomyLog(i,{category:"meta_exp",source:e,amount:t,before:a,after:i.exp,meta:{...s,level:i.level}}),this.save(i)}static unlockCharacter(t){let e=this.get();e.unlockedCharacters.includes(t)||e.unlockedCharacters.push(t),e.characterData[t]||(e.characterData[t]={level:1,exp:0,dupeCount:0,uncap:0}),this.save(e)}static setSelectedCharacter(t){let e=this.get();e.unlockedCharacters.includes(t)&&(e.selectedCharacterId=t,this.save(e))}static getCharacterData(t){return this.get().characterData[t]||{level:1,exp:0,dupeCount:0,uncap:0}}static levelUpCharacter(t,e){let s=this.get();if(s.credits<e)return!1;s.characterData[t]||(s.characterData[t]={level:1,exp:0,dupeCount:0,uncap:0});const i=s.credits;return s.credits-=e,s.characterData[t].level++,this.appendEconomyLog(s,{category:"credits",source:"character_levelup",amount:-e,before:i,after:s.credits,meta:{charId:t,levelAfter:s.characterData[t].level}}),this.save(s),!0}static addCharacterDupe(t){let e=this.get();return e.characterData[t]||(e.characterData[t]={level:1,exp:0,dupeCount:0,uncap:0}),e.characterData[t].dupeCount++,this.appendEconomyLog(e,{category:"character_shard",source:"gacha_duplicate",amount:1,before:e.characterData[t].dupeCount-1,after:e.characterData[t].dupeCount,meta:{charId:t}}),this.save(e),e.characterData[t].dupeCount}static uncapCharacter(t){let e=this.get();const s=e.characterData[t];if(!s)return!1;const i=(s.uncap+1)*2;if(s.dupeCount<i)return!1;const a=s.dupeCount;return s.dupeCount-=i,s.uncap++,this.appendEconomyLog(e,{category:"character_shard",source:"character_uncap",amount:-i,before:a,after:s.dupeCount,meta:{charId:t,uncapAfter:s.uncap}}),this.save(e),!0}static buyUpgrade(t){let e=this.get();e.upgrades[t]||(e.upgrades[t]=0),e.upgrades[t]++,this.save(e)}static updateLoginBonus(t){let e=this.get();e.loginBonus={...e.loginBonus,...t},this.save(e)}static updateMissions(t){let e=this.get();e.missions={...e.missions,...t},this.save(e)}static incrementPity(){let t=this.get();return t.pityCounter=(t.pityCounter||0)+1,this.save(t),t.pityCounter}static resetPity(){let t=this.get();t.pityCounter=0,this.save(t)}static addBattlePassExp(t,e="unknown",s={}){let i=this.get();const a=i.battlePass.level,r=i.battlePass.exp;i.battlePass.exp+=t;const n=500;for(;i.battlePass.exp>=n&&i.battlePass.level<30;)i.battlePass.exp-=n,i.battlePass.level++;return this.appendEconomyLog(i,{category:"battlepass_exp",source:e,amount:t,before:r,after:i.battlePass.exp,meta:{...s,levelBefore:a,levelAfter:i.battlePass.level}}),this.save(i),i.battlePass}static claimBattlePassReward(t){let e=this.get();return e.battlePass.claimed.includes(t)?!1:(e.battlePass.claimed.push(t),this.save(e),!0)}static completeTutorial(){let t=this.get();t.tutorialDone=!0,this.save(t)}static updateNotifications(t){let e=this.get();e.notifications={...e.notifications,...t},this.save(e)}static getNotifications(){return this.get().notifications}static getEconomyLedger(t=100){const e=this.get().economyLedger||[];return t<=0?[...e].reverse():e.slice(-t).reverse()}static exportSnapshot(){return this.get()}static applyServerSnapshot(t){if(!t||typeof t!="object")return!1;const e=this.getDefaultData(),s={...e,...t};s.stats={...e.stats,...t.stats||{}},s.loginBonus={...e.loginBonus,...t.loginBonus||{}},s.missions={...e.missions,...t.missions||{}},s.battlePass={...e.battlePass,...t.battlePass||{}},s.notifications={...e.notifications,...t.notifications||{}},s.characterData=t.characterData||{},s.economyLedger=Array.isArray(t.economyLedger)?t.economyLedger:[];const i=this.migrateSaveData(s);return this.save(i.data),!0}static addMatchResult(t,e,s=0){const i=Math.max(0,t||0),a=Math.max(0,e||0),r=Math.max(0,s||0),n=Math.floor(i*10)+a*50,l=Math.floor(i*5)+a*20;let o=this.get();const c=o.credits,u=o.exp;o.credits+=n,o.exp+=l,o.stats.totalMatches++,o.stats.totalKills+=a,o.stats.totalNodesCaptured+=r,o.stats.bestDomination=Math.max(o.stats.bestDomination,i),o.stats.bestKills=Math.max(o.stats.bestKills,a),i>35&&o.stats.winCount++;let p=o.level*1e3;for(;o.exp>=p;)o.level++,o.exp-=p,o.gems+=50,this.appendEconomyLog(o,{category:"gems",source:"meta_levelup_bonus",amount:50,before:o.gems-50,after:o.gems,meta:{level:o.level}}),p=o.level*1e3;return this.appendEconomyLog(o,{category:"credits",source:"match_result",amount:n,before:c,after:o.credits,meta:{domination:i,kills:a,nodes:r}}),this.appendEconomyLog(o,{category:"meta_exp",source:"match_result",amount:l,before:u,after:o.exp,meta:{domination:i,kills:a,nodes:r,level:o.level}}),this.save(o),{creditsEarned:n,expEarned:l,dominationPercent:i,kills:a,nodesCaptured:r}}static migrateSaveData(t){const e={...t};let s=!1;return Number(e.schemaVersion||1)<2&&(Array.isArray(e.economyLedger)||(e.economyLedger=[]),e.schemaVersion=2,s=!0),e.schemaVersion!==A&&(e.schemaVersion=A,s=!0),Array.isArray(e.economyLedger)||(e.economyLedger=[],s=!0),{data:e,changed:s}}static appendEconomyLog(t,e){Array.isArray(t.economyLedger)||(t.economyLedger=[]),t.economyLedger.push({timestamp:new Date().toISOString(),...e}),t.economyLedger.length>_&&t.economyLedger.splice(0,t.economyLedger.length-_)}}const v={1:{id:1,name:"ネオンアサシン",rarity:"R",description:"標準型。バランスの取れた戦闘ステータス。",stats:{speed:5.5,attackRadius:36,attackArc:Math.PI/1.5,slashes:1,maxHp:3},growth:{speed:.15,attackRadius:1.2,maxHp:0},uncapBonus:{speed:.3,attackRadius:2,maxHp:1},levelUpCost:300,color:"#00ffff",spriteClass:"char-sprite-cyan"},2:{id:2,name:"タイタンブルーザー",rarity:"SR",description:"重装型。広範囲攻撃・低機動。",stats:{speed:4.8,attackRadius:42,attackArc:Math.PI,slashes:1,maxHp:4},growth:{speed:.1,attackRadius:1.5,maxHp:0},uncapBonus:{speed:.25,attackRadius:3,maxHp:1},levelUpCost:500,color:"#ff00ff",spriteClass:"char-sprite-fuchsia"},3:{id:3,name:"ファントムブレイド",rarity:"SSR",description:"高速型。二段斬りの致命的な一撃。",stats:{speed:6.8,attackRadius:32,attackArc:Math.PI/1.8,slashes:2,maxHp:2},growth:{speed:.2,attackRadius:1,maxHp:0},uncapBonus:{speed:.4,attackRadius:2,maxHp:1},levelUpCost:800,color:"#ffdd66",spriteClass:"char-sprite-gold"}};function Z(h,t=1,e=0){const s=v[h];if(!s)return v[1].stats;const i=Math.max(0,t-1);return{speed:s.stats.speed+s.growth.speed*i+s.uncapBonus.speed*e,attackRadius:s.stats.attackRadius+s.growth.attackRadius*i+s.uncapBonus.attackRadius*e,attackArc:s.stats.attackArc,slashes:s.stats.slashes,maxHp:s.stats.maxHp+s.growth.maxHp*i+s.uncapBonus.maxHp*e}}function lt(h,t){const e=v[h];return e?e.levelUpCost+(t-1)*Math.floor(e.levelUpCost*.5):9999}const R=[{id:1,weight:60},{id:2,weight:30},{id:3,weight:10}],ht={speed:"SURGE",range:"FRACTURE",paint:"INKCORE",magnet:"MAGNET"},ct={kinetic:"KINETIC",fracture:"FRACTURE+",overpaint:"OVERPAINT",tempo:"TEMPO",vacuum:"VACUUM+",overload:"OVERLOAD"};class U{constructor(t,e){this.id=1,this.x=t,this.y=e,this.radius=20;const s=d.getSelectedCharacter(),i=d.getCharacterData(s),a=Z(s,i.level,i.uncap);this.color=v[s]?v[s].color:"#00ffff";const r=d.getUpgrades();this.baseSpeed=a.speed*80+r.speed*40,this.speed=this.baseSpeed,this.basePaintRadius=40,this.paintRadius=this.basePaintRadius,this.level=1,this.exp=0,this.expToNext=10,this.maxLives=a.maxHp+r.hp*1,this.lives=this.maxLives,this.baseAttackRadius=a.attackRadius*2.5,this.attackArc=a.attackArc,this.slashes=a.slashes,this.attackRadius=this.baseAttackRadius,this.attackCooldown=0,this.baseMaxCooldown=.5,this.maxCooldown=this.baseMaxCooldown,this.isAttacking=!1,this.justAttacked=!1,this.attackAnimRatio=0,this.baseExpPickupBonus=r.magnet*20,this.expPickupBonus=this.baseExpPickupBonus,this.pendingSlashBursts=0,this.slashBurstTimer=0,this.slashBurstInterval=.08,this.buffDurations={speed:0,range:0,paint:0,magnet:0},this.perkBonuses={speed:1,range:1,paint:1,cooldown:1,magnet:0,overdrive:1},this.perkStacks={},this.updateHpUI()}addExp(t){for(this.exp+=t;this.exp>=this.expToNext;)this.levelUp();this.updateExpUI()}levelUp(){this.level++,this.exp-=this.expToNext,this.expToNext=Math.floor(this.expToNext*1.5),this.updateLevelUI()}updateLevelUI(){const t=document.getElementById("level-display");t&&(t.innerText=this.level)}updateExpUI(){const t=document.getElementById("exp-bar-fill");if(!t)return;const e=Math.min(this.exp/this.expToNext*100,100);t.style.width=`${e}%`}applyBuff(t,e=10){t in this.buffDurations&&(this.buffDurations[t]=Math.max(this.buffDurations[t],e))}clearBuffs(){for(const t of Object.keys(this.buffDurations))this.buffDurations[t]=0}updateBuffs(t){for(const e of Object.keys(this.buffDurations))this.buffDurations[e]>0&&(this.buffDurations[e]=Math.max(0,this.buffDurations[e]-t))}getBuffSnapshot(){return Object.keys(this.buffDurations).filter(t=>this.buffDurations[t]>0).map(t=>({type:t,label:ht[t],remaining:this.buffDurations[t]})).sort((t,e)=>e.remaining-t.remaining)}applyPerk(t){switch(this.perkStacks[t]=(this.perkStacks[t]||0)+1,t){case"kinetic":this.perkBonuses.speed*=1.1;break;case"fracture":this.perkBonuses.range*=1.13;break;case"overpaint":this.perkBonuses.paint*=1.14;break;case"tempo":this.perkBonuses.cooldown*=1.12;break;case"vacuum":this.perkBonuses.magnet+=45;break;case"overload":this.perkBonuses.overdrive*=1.12;break}}getPerkSummary(t=3){return Object.entries(this.perkStacks).filter(([,e])=>e>0).map(([e,s])=>`${ct[e]||e.toUpperCase()}${s>1?`x${s}`:""}`).slice(0,t)}getOverdriveGainMultiplier(){return this.perkBonuses.overdrive}recalculateStats(t){const e=this.baseSpeed+this.level*50,s=this.baseAttackRadius+this.level*20,i=this.basePaintRadius+Math.min(this.level*2,30),a=this.buffDurations.speed>0?1.35:1,r=this.buffDurations.range>0?1.45:1,n=this.buffDurations.paint>0?1.6:1,l=t?.speed??1,o=t?.cooldown??1;this.speed=e*a*this.perkBonuses.speed*l,this.attackRadius=s*r*this.perkBonuses.range,this.paintRadius=i*n*this.perkBonuses.paint,this.maxCooldown=this.baseMaxCooldown/(o*this.perkBonuses.cooldown),this.expPickupBonus=this.baseExpPickupBonus+(this.buffDurations.magnet>0?140:0)+this.perkBonuses.magnet}die(){this.level>1&&(this.level--,this.exp=0,this.expToNext=Math.max(10,Math.floor(this.expToNext/1.5)),this.updateLevelUI(),this.updateExpUI()),this.clearBuffs()}restoreLives(){this.lives=this.maxLives,this.updateHpUI()}takeHit(t=1){return this.lives=Math.max(0,this.lives-t),this.updateHpUI(),this.lives<=0}updateHpUI(){const t=document.getElementById("hp-display");if(!t)return;const e=Math.max(1,this.maxLives);t.innerHTML="";for(let s=0;s<e;s++){const i=document.createElement("span");i.className=`hp-pip ${s<this.lives?"active":""}`,t.appendChild(i)}}update(t,e,s,i,a={speed:1,cooldown:1}){const r=t/1e3;this.justAttacked=!1,this.updateBuffs(r),this.recalculateStats(a),(e.x!==0||e.y!==0)&&(this.x+=e.x*this.speed*r,this.y+=e.y*this.speed*r),this.x=Math.max(this.radius,Math.min(i.width-this.radius,this.x)),this.y=Math.max(this.radius,Math.min(i.height-this.radius,this.y)),i.paintRadius(this.x,this.y,this.paintRadius,this.id),this.attackCooldown>0?(this.attackCooldown=Math.max(0,this.attackCooldown-r),this.attackAnimRatio+=r/.1,this.pendingSlashBursts>0&&(this.slashBurstTimer-=r,this.slashBurstTimer<=0&&(this.justAttacked=!0,this.attackAnimRatio=0,this.pendingSlashBursts--,this.slashBurstTimer=this.slashBurstInterval)),this.attackCooldown<=0&&(this.isAttacking=!1,this.pendingSlashBursts=0)):s?(this.isAttacking=!0,this.justAttacked=!0,this.attackCooldown=this.maxCooldown,this.attackAnimRatio=0,this.pendingSlashBursts=Math.max(0,Math.floor(this.slashes)-1),this.slashBurstTimer=this.slashBurstInterval):this.isAttacking=!1}draw(t,e,s){if(t.save(),t.translate(this.x-e,this.y-s),Object.values(this.buffDurations).some(a=>a>0)&&(t.beginPath(),t.arc(0,0,this.radius+22,0,Math.PI*2),t.strokeStyle="rgba(255, 220, 90, 0.8)",t.lineWidth=2,t.stroke()),t.beginPath(),t.arc(0,0,this.radius+15,0,Math.PI*2),t.fillStyle=this.color,t.globalAlpha=.3,t.fill(),t.closePath(),t.globalAlpha=1,t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ffffff",t.fill(),t.closePath(),t.beginPath(),t.moveTo(0,0),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle=this.color,t.fill(),t.strokeStyle="#fff",t.lineWidth=2,t.stroke(),this.isAttacking){t.beginPath(),t.moveTo(0,0);const a=this.attackRadius*this.attackAnimRatio;t.arc(0,0,a,-this.attackArc/2,this.attackArc/2),t.fillStyle=`rgba(${this.hexToRgb(this.color)}, 0.4)`,t.fill(),t.lineWidth=2,t.strokeStyle=this.color,t.stroke()}if(t.closePath(),t.beginPath(),t.arc(0,0,this.attackRadius,0,Math.PI*2),t.strokeStyle="rgba(0, 255, 255, 0.15)",t.lineWidth=2,t.stroke(),t.closePath(),this.attackCooldown>0&&this.attackAnimRatio<=1){const a=this.attackRadius*this.attackAnimRatio;t.beginPath(),t.arc(0,0,a,-Math.PI,Math.PI),t.strokeStyle=this.color,t.lineWidth=15,t.globalAlpha=.3,t.stroke(),t.closePath(),t.globalAlpha=1,t.beginPath(),t.arc(0,0,a,-Math.PI,Math.PI),t.strokeStyle="#ffffff",t.lineWidth=3,t.stroke(),t.closePath()}t.restore()}hexToRgb(t){const e=t.replace("#",""),s=e.length===3?e.split("").map(l=>l+l).join(""):e,i=Number.parseInt(s,16);if(Number.isNaN(i))return"0, 255, 255";const a=i>>16&255,r=i>>8&255,n=i&255;return`${a}, ${r}, ${n}`}}const G=["零式_デーモン","トキシック","狙撃の神","ヌーブ太郎","ガチ勢99","αウルフ","幻影","殲滅者","影忍","渦流"],tt={hunter:{label:"狩猟",color:"#ff4d6d",speedMult:1.08,cooldownMult:1.2,paintMult:.95},painter:{label:"塗装",color:"#ff00ff",speedMult:.95,cooldownMult:1,paintMult:1.35},collector:{label:"収集",color:"#ffb347",speedMult:1.12,cooldownMult:.95,paintMult:1.05}},j=Object.keys(tt);class dt{constructor(t,e,s){this.id=t,this.x=e,this.y=s,this.name=G[Math.floor(Math.random()*G.length)]||"Bot",this.role=j[Math.floor(Math.random()*j.length)],this.roleConfig=tt[this.role],this.radius=20,this.baseSpeed=340,this.speed=this.baseSpeed,this.color=this.roleConfig.color,this.basePaintRadius=40,this.paintRadius=this.basePaintRadius,this.level=1,this.exp=0,this.expToNext=10,this.baseAttackRadius=100,this.attackRadius=this.baseAttackRadius,this.attackCooldown=0,this.baseMaxCooldown=.8,this.maxCooldown=this.baseMaxCooldown,this.isAttacking=!1,this.justAttacked=!1,this.attackAnimRatio=0,this.state="wander",this.targetX=e+(Math.random()-.5)*500,this.targetY=s+(Math.random()-.5)*500,this.recalculateTimer=0,this.currentTarget=null,this.expPickupBonus=this.role==="collector"?80:0,this.buffDurations={speed:0,range:0,paint:0,magnet:0}}addExp(t){for(this.exp+=t;this.exp>=this.expToNext;)this.levelUp()}levelUp(){this.level++,this.exp-=this.expToNext,this.expToNext=Math.floor(this.expToNext*1.5)}die(){this.level>1&&(this.level--,this.exp=0,this.expToNext=Math.max(10,Math.floor(this.expToNext/1.5))),this.clearBuffs()}applyBuff(t,e=10){t in this.buffDurations&&(this.buffDurations[t]=Math.max(this.buffDurations[t],e))}clearBuffs(){for(const t of Object.keys(this.buffDurations))this.buffDurations[t]=0}updateBuffs(t){for(const e of Object.keys(this.buffDurations))this.buffDurations[e]>0&&(this.buffDurations[e]=Math.max(0,this.buffDurations[e]-t))}recalculateStats(t){const e=this.buffDurations.speed>0?1.28:1,s=this.buffDurations.range>0?1.3:1,i=this.buffDurations.paint>0?1.45:1,a=t?.speed??1,r=t?.cooldown??1,n=this.baseSpeed+this.level*40,l=this.baseAttackRadius+this.level*18,o=this.basePaintRadius+Math.min(this.level*2,26);this.speed=n*this.roleConfig.speedMult*e*a,this.attackRadius=l*s,this.paintRadius=o*this.roleConfig.paintMult*i,this.maxCooldown=this.baseMaxCooldown/this.roleConfig.cooldownMult/r,this.expPickupBonus=(this.role==="collector"?80:0)+(this.buffDurations.magnet>0?120:0)}findNearest(t,e=()=>!0){let s=null,i=1/0;for(const a of t){if(!e(a))continue;const r=Math.hypot(a.x-this.x,a.y-this.y);r<i&&(s=a,i=r)}return{item:s,dist:i}}recalculateTarget(t,e,s,i,a,r){if(this.currentTarget=null,this.state="wander",r&&Math.hypot(r.x-this.x,r.y-this.y)<1200&&(this.role!=="collector"||Math.random()<.65)){this.state="chase",this.currentTarget=r,this.targetX=r.x,this.targetY=r.y;return}if(this.role==="collector"){const o=this.findNearest(a);if(o.item&&o.dist<900){this.state="chase",this.currentTarget=o.item,this.targetX=o.item.x,this.targetY=o.item.y;return}const c=this.findNearest(i);if(c.item&&c.dist<1e3){this.state="chase",this.currentTarget=c.item,this.targetX=c.item.x,this.targetY=c.item.y;return}}const n=[e,...s.filter(o=>o.id!==this.id)],l=this.findNearest(n);if(this.role==="hunter"&&Math.hypot(e.x-this.x,e.y-this.y)<1400){this.state="chase",this.currentTarget=e,this.targetX=e.x,this.targetY=e.y;return}if(this.role==="painter"&&Math.random()<.6){this.state="wander",this.targetX=Math.random()*t.width,this.targetY=Math.random()*t.height;return}if(l.item&&l.dist<900){this.state="chase",this.currentTarget=l.item,this.targetX=l.item.x,this.targetY=l.item.y;return}this.state="wander",this.targetX=this.x+(Math.random()-.5)*700,this.targetY=this.y+(Math.random()-.5)*700}update(t,e,s,i,a,r=[],n=null,l={speed:1,cooldown:1}){const o=t/1e3;this.recalculateTimer-=o,this.justAttacked=!1,this.updateBuffs(o),this.recalculateStats(l),this.recalculateTimer<=0&&(this.recalculateTimer=.4+Math.random()*.5,this.recalculateTarget(e,s,i,a,r,n)),this.currentTarget&&this.currentTarget.x!==void 0&&(this.targetX=this.currentTarget.x,this.targetY=this.currentTarget.y);const c=this.targetX-this.x,u=this.targetY-this.y,p=Math.hypot(c,u);if(p>10&&(this.x+=c/p*this.speed*o,this.y+=u/p*this.speed*o),this.x=Math.max(this.radius,Math.min(e.width-this.radius,this.x)),this.y=Math.max(this.radius,Math.min(e.height-this.radius,this.y)),e.paintRadius(this.x,this.y,this.paintRadius,this.id),this.attackCooldown>0)this.attackCooldown=Math.max(0,this.attackCooldown-o),this.attackAnimRatio+=o/.1,this.attackCooldown<=0&&(this.isAttacking=!1);else{this.isAttacking=!1;const m=this.currentTarget;if(m&&m.radius){const g=Math.hypot(m.x-this.x,m.y-this.y),w=this.role==="hunter"?.95:.8;g<this.attackRadius*w&&(this.isAttacking=!0,this.justAttacked=!0,this.attackCooldown=this.maxCooldown,this.attackAnimRatio=0)}}}draw(t,e,s){if(t.save(),t.translate(this.x-e,this.y-s),t.beginPath(),t.arc(0,0,this.radius+10,0,Math.PI*2),t.fillStyle=this.color,t.globalAlpha=.28,t.fill(),t.closePath(),t.globalAlpha=1,t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ffffff",t.fill(),t.closePath(),t.beginPath(),t.arc(0,0,this.radius-4,0,Math.PI*2),t.fillStyle=this.color,t.fill(),t.closePath(),t.beginPath(),t.arc(0,0,this.attackRadius,0,Math.PI*2),t.strokeStyle="rgba(255, 120, 210, 0.14)",t.lineWidth=2,t.stroke(),t.closePath(),this.attackCooldown>0&&this.attackAnimRatio<=1){const i=this.attackRadius*this.attackAnimRatio;t.beginPath(),t.arc(0,0,i,-Math.PI,Math.PI),t.strokeStyle=this.color,t.lineWidth=12,t.globalAlpha=.3,t.stroke(),t.closePath(),t.globalAlpha=1,t.beginPath(),t.arc(0,0,i,-Math.PI,Math.PI),t.strokeStyle="#ffffff",t.lineWidth=2,t.stroke(),t.closePath()}t.fillStyle="white",t.font="11px Orbitron",t.textAlign="center",t.shadowBlur=0,t.fillText(this.name,0,-this.radius-12),t.fillStyle=this.color,t.font="9px Orbitron",t.fillText(this.roleConfig.label,0,-this.radius-24),t.restore()}}class ut{constructor(t,e){this.x=t,this.y=e,this.radius=10,this.color="#ccff00",this.value=5;const s=Math.random()*Math.PI*2,i=Math.random()*400+200;this.vx=Math.cos(s)*i,this.vy=Math.sin(s)*i,this.friction=.92,this.rotation=Math.random()*Math.PI,this.rotationSpeed=(Math.random()-.5)*5}update(t,e,s,i){const a=t/1e3;for(const r of e){const n=r.expPickupBonus||0;if(n<=0)continue;const l=r.x-this.x,o=r.y-this.y,c=Math.hypot(l,o),u=130+n;if(c>2&&c<u){const p=(1-c/u)*900;this.vx+=l/c*p*a,this.vy+=o/c*p*a}}this.x+=this.vx*a,this.y+=this.vy*a,this.vx*=this.friction,this.vy*=this.friction,(this.x<this.radius||this.x>s-this.radius)&&(this.vx*=-1,this.x=Math.max(this.radius,Math.min(s-this.radius,this.x))),(this.y<this.radius||this.y>i-this.radius)&&(this.vy*=-1,this.y=Math.max(this.radius,Math.min(i-this.radius,this.y))),this.rotation+=this.rotationSpeed*a;for(const r of e){const n=Math.hypot(r.x-this.x,r.y-this.y),l=(r.expPickupBonus||0)*.4;if(n<r.radius+this.radius+10+l)return r.addExp(this.value),!0}return!1}draw(t,e,s){t.save(),t.translate(this.x-e,this.y-s),t.rotate(this.rotation),t.fillStyle=this.color,t.globalAlpha=.3,t.beginPath(),t.rect(-this.radius,-this.radius,this.radius*2,this.radius*2),t.fill(),t.closePath(),t.globalAlpha=1,t.beginPath(),t.rect(-this.radius/2,-this.radius/2,this.radius,this.radius),t.fill(),t.closePath(),t.restore()}}class pt{constructor(){this.shakeTime=0,this.shakeMagnitude=0,this.hitstopTime=0,this.particles=[],this.streakCount=0,this.streakTimer=0,this.centerMessage=document.getElementById("center-message"),this.streakText=document.getElementById("streak-text")}triggerShake(t,e){this.shakeMagnitude=t,this.shakeTime=e}triggerHitstop(t){this.hitstopTime=t}triggerKillStreak(){this.streakCount++,this.streakTimer=4;let t="";this.streakCount===2?t="ダブルキル！":this.streakCount===3?t="トリプルキル!!":this.streakCount===4?t="オーバーキル!!!":this.streakCount>=5&&(t="暴走!!!!"),t&&(this.streakText.innerText=t,this.centerMessage.classList.remove("hidden"),this.streakText.style.animation="none",this.streakText.offsetHeight,this.streakText.style.animation="popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)")}spawnExplosion(t,e,s){for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2,r=Math.random()*300+100;this.particles.push({x:t,y:e,vx:Math.cos(a)*r,vy:Math.sin(a)*r,life:1,color:s,size:Math.random()*6+2})}}update(t){const e=t/1e3;if(this.streakTimer>0&&(this.streakTimer-=e,this.streakTimer<=0&&(this.streakCount=0,this.centerMessage.classList.add("hidden"))),this.hitstopTime>0)return this.hitstopTime-=e,!0;this.shakeTime>0&&(this.shakeTime-=e);for(let s=this.particles.length-1;s>=0;s--){let i=this.particles[s];i.x+=i.vx*e,i.y+=i.vy*e,i.life-=e*2.5,i.life<=0&&this.particles.splice(s,1)}return!1}getShakeOffset(){if(this.shakeTime>0){const t=(Math.random()-.5)*this.shakeMagnitude,e=(Math.random()-.5)*this.shakeMagnitude;return{x:t,y:e}}return{x:0,y:0}}draw(t,e,s){t.save(),t.translate(-e,-s);for(const i of this.particles)t.fillStyle=i.color,t.globalAlpha=Math.max(0,i.life*.4),t.beginPath(),t.arc(i.x,i.y,i.size*2,0,Math.PI*2),t.fill(),t.globalAlpha=Math.max(0,i.life),t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fill();t.restore()}}class ft{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext),this.bgmOsc=null,this.bgmLfo=null,this.bgmGain=null,this.isPlayingBGM=!1;const t=()=>{this.ctx.state==="suspended"&&this.ctx.resume(),window.removeEventListener("click",t),window.removeEventListener("touchstart",t),window.removeEventListener("keydown",t)};window.addEventListener("click",t),window.addEventListener("touchstart",t),window.addEventListener("keydown",t)}playBGM(){if(this.isPlayingBGM)return;this.isPlayingBGM=!0,this.ctx.state==="suspended"&&this.ctx.resume(),this.bgmGain=this.ctx.createGain(),this.bgmGain.gain.value=.1,this.bgmGain.connect(this.ctx.destination),this.bgmOsc=this.ctx.createOscillator(),this.bgmOsc.type="sawtooth",this.bgmOsc.frequency.setValueAtTime(55,this.ctx.currentTime);const t=this.ctx.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(200,this.ctx.currentTime);const e=this.ctx.createOscillator();e.type="triangle",e.frequency.value=4;const s=this.ctx.createGain();s.gain.value=400,e.connect(s),s.connect(t.frequency),e.start(),this.bgmOsc.connect(t),t.connect(this.bgmGain),this.bgmOsc.start(),this.bgmLfo=e}stopBGM(){this.bgmOsc&&(this.bgmOsc.stop(),this.bgmOsc.disconnect(),this.bgmOsc=null,this.isPlayingBGM=!1),this.bgmLfo&&(this.bgmLfo.stop(),this.bgmLfo.disconnect(),this.bgmLfo=null)}playSlash(){if(this.ctx.state==="suspended")return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(800,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+.1),e.gain.setValueAtTime(.3,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.ctx.destination),t.start(),t.stop(this.ctx.currentTime+.1)}playKill(){if(this.ctx.state==="suspended")return;const t=this.ctx.sampleRate*.2,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate),s=e.getChannelData(0);for(let n=0;n<t;n++)s[n]=Math.random()*2-1;const i=this.ctx.createBufferSource();i.buffer=e;const a=this.ctx.createBiquadFilter();a.type="lowpass",a.frequency.setValueAtTime(1e3,this.ctx.currentTime);const r=this.ctx.createGain();r.gain.setValueAtTime(.5,this.ctx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),i.connect(a),a.connect(r),r.connect(this.ctx.destination),i.start()}playLevelUp(){if(this.ctx.state==="suspended")return;[523.25,659.25,783.99,1046.5].forEach((e,s)=>{const i=this.ctx.createOscillator(),a=this.ctx.createGain();i.type="square",i.frequency.setValueAtTime(e,this.ctx.currentTime+s*.1),a.gain.setValueAtTime(0,this.ctx.currentTime),a.gain.setValueAtTime(.2,this.ctx.currentTime+s*.1),a.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+s*.1+.2),i.connect(a),a.connect(this.ctx.destination),i.start(this.ctx.currentTime+s*.1),i.stop(this.ctx.currentTime+s*.1+.2)})}playOverdrive(){if(this.ctx.state==="suspended")return;const t=this.ctx.currentTime,e=this.ctx.createOscillator(),s=this.ctx.createGain(),i=this.ctx.createBiquadFilter();e.type="sawtooth",e.frequency.setValueAtTime(140,t),e.frequency.exponentialRampToValueAtTime(40,t+.35),i.type="bandpass",i.frequency.setValueAtTime(700,t),i.frequency.exponentialRampToValueAtTime(180,t+.35),i.Q.value=8,s.gain.setValueAtTime(.001,t),s.gain.exponentialRampToValueAtTime(.4,t+.02),s.gain.exponentialRampToValueAtTime(.01,t+.35),e.connect(i),i.connect(s),s.connect(this.ctx.destination),e.start(t),e.stop(t+.36)}}const $={speed:{label:"加速",color:"#22e4ff",duration:10,description:"移動速度UP"},range:{label:"干渉",color:"#ff5bd6",duration:10,description:"攻撃範囲UP"},paint:{label:"浸食",color:"#9cff3a",duration:10,description:"塗り半径UP"},magnet:{label:"磁場",color:"#ffc94f",duration:10,description:"EXP回収範囲UP"}},H=Object.keys($);class mt{constructor(t,e,s){this.type=t,this.x=e,this.y=s,this.radius=16,this.lifeTime=20,this.elapsed=0,this.spin=Math.random()*Math.PI*2}update(t,e){const s=t/1e3;this.elapsed+=s,this.spin+=s*2.4;for(const i of e)if(Math.hypot(i.x-this.x,i.y-this.y)<=this.radius+i.radius+8)return{collected:!0,collector:i,expired:!1};return this.elapsed>=this.lifeTime?{collected:!1,collector:null,expired:!0}:{collected:!1,collector:null,expired:!1}}draw(t,e,s){const i=$[this.type];if(!i)return;const a=this.x-e,r=this.y-s,n=1+Math.sin(this.elapsed*5)*.12;t.save(),t.translate(a,r),t.rotate(this.spin),t.globalAlpha=.24,t.fillStyle=i.color,t.beginPath(),t.arc(0,0,this.radius*1.5*n,0,Math.PI*2),t.fill(),t.globalAlpha=1,t.strokeStyle=i.color,t.lineWidth=3,t.beginPath(),t.moveTo(0,-this.radius*n),t.lineTo(this.radius*n,0),t.lineTo(0,this.radius*n),t.lineTo(-this.radius*n,0),t.closePath(),t.stroke(),t.fillStyle="#ffffff",t.font="bold 10px Orbitron",t.textAlign="center",t.textBaseline="middle",t.fillText(i.label[0],0,0),t.restore()}}const V={stable:{label:"フェーズ: 安定",speed:1,cooldown:1,color:"#00ffff"},storm:{label:"フェーズ: 電磁嵐",speed:1.04,cooldown:1,color:"#66ccff"},overclock:{label:"フェーズ: 過負荷",speed:1.2,cooldown:1.35,color:"#ff9d2e"}},f={matchDuration:82,botCount:7,objectiveInitialDelay:12,objectiveRespawnDelay:12,objectiveLostRespawnDelay:9,objectiveDuration:16,objectiveCaptureGoal:120,objectiveCaptureRate:40,objectiveDecayEnemy:12,objectiveDecayNeutral:6,relicInitialDelay:7,relicMaxOnMap:3,relicRespawnMin:6,relicRespawnRange:4,phaseStormAt:50,phaseOverclockAt:18,overdriveMax:100,overdriveRelicGain:6,overdriveNodeGain:40,overdriveLevelGain:10,overdriveKillGain:18,overdriveNovaKillGain:10},et=[{id:"kinetic",name:"加速キネティクス",desc:"移動速度 +10%（永続）"},{id:"fracture",name:"フラクチャー干渉",desc:"攻撃範囲 +13%（永続）"},{id:"overpaint",name:"過浸食コア",desc:"塗り半径 +14%（永続）"},{id:"tempo",name:"テンポループ",desc:"攻撃テンポ +12%（永続）"},{id:"vacuum",name:"吸引フィールド",desc:"EXP回収範囲 +45（重複可）"},{id:"overload",name:"過充電バス",desc:"OD蓄積量 +12%（重複可）"}],z=Object.fromEntries(et.map(h=>[h.id,h]));function E(h,t,e){return Math.max(t,Math.min(e,h))}function gt(h){return h===1?1:2}class yt{constructor(t,e){this.width=t,this.height=e,this.worldWidth=3e3,this.worldHeight=3e3,this.matchDuration=f.matchDuration,this.grid=new N(this.worldWidth,this.worldHeight,50),this.player=new U(this.worldWidth/2,this.worldHeight/2),this.bots=this.createBots(f.botCount),this.state="playing",this.timer=this.matchDuration,this.tickId=0,this.cameraX=0,this.cameraY=0,this.timerDisplay=document.getElementById("timer-display"),this.dominationDisplay=document.getElementById("domination-display"),this.finalDomination=document.getElementById("final-domination"),this.finalKills=document.getElementById("final-kills"),this.resultScreen=document.getElementById("result-screen"),this.resultTitle=document.getElementById("result-title"),this.phaseDisplay=document.getElementById("phase-display"),this.objectiveStatus=document.getElementById("objective-status"),this.buffStatus=document.getElementById("buff-status"),this.perkStatus=document.getElementById("perk-status"),this.overdriveFill=document.getElementById("overdrive-fill"),this.overdriveLabel=document.getElementById("overdrive-label"),this.overdriveHint=document.getElementById("overdrive-hint"),this.perkScreen=document.getElementById("perk-screen"),this.perkOptions=document.getElementById("perk-options");const s=this.resultScreen.querySelector(".rewards-display");s&&s.remove(),this.rewardDisplay=document.createElement("div"),this.rewardDisplay.className="rewards-display",this.rewardDisplay.style.marginTop="20px",this.rewardDisplay.style.fontSize="20px",this.rewardDisplay.style.color="#ffcc00",this.resultScreen.insertBefore(this.rewardDisplay,document.getElementById("rematch-btn")),this.userData=d,this.pendingPerkChoices=0,this.isPerkSelectionOpen=!1,this.currentPerkChoices=[],this.inputFallback={isAttacking:!1,getVector:()=>({x:0,y:0}),consumeUltimate:()=>!1},this.initPerkUI()}createBots(t){const e=[];for(let s=0;s<t;s++){const i=this.randomPoint(140);e.push(new dt(s+2,i.x,i.y))}return e}initPerkUI(){this.perkOptions&&this.perkOptions.addEventListener("click",t=>{const e=t.target.closest(".perk-option");if(!e||!this.isPerkSelectionOpen)return;const s=e.dataset.perkId;this.selectPerk(s)})}rollPerkChoices(t=2){const e=[...et];for(let s=e.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[e[s],e[i]]=[e[i],e[s]]}return e.slice(0,Math.min(t,e.length))}openPerkSelection(){if(this.pendingPerkChoices<=0||this.isPerkSelectionOpen||this.state!=="playing")return;const t=this.rollPerkChoices(2);if(t.length===0){this.pendingPerkChoices=0;return}if(this.currentPerkChoices=t,!this.perkScreen||!this.perkOptions){this.applyPerk(t[0].id),this.pendingPerkChoices=Math.max(0,this.pendingPerkChoices-1),this.pendingPerkChoices>0&&this.openPerkSelection();return}this.perkOptions.innerHTML=t.map(e=>`
            <button class="perk-option" data-perk-id="${e.id}">
                <span class="perk-name">${e.name}</span>
                <span class="perk-desc">${e.desc}</span>
            </button>
        `).join(""),this.perkScreen.classList.remove("hidden"),this.isPerkSelectionOpen=!0}closePerkSelection(){this.isPerkSelectionOpen=!1,this.currentPerkChoices=[],this.perkScreen&&this.perkScreen.classList.add("hidden")}applyPerk(t){const e=z[t];!e||!this.player||(this.player.applyPerk(e.id),this.setAlert(`PERK INSTALLED: ${e.name.toUpperCase()}`,1.6))}selectPerk(t){const e=this.currentPerkChoices[0]?.id,s=z[t]?t:e;s&&(this.applyPerk(s),this.pendingPerkChoices=Math.max(0,this.pendingPerkChoices-1),this.closePerkSelection(),this.pendingPerkChoices>0&&this.openPerkSelection())}randomPoint(t=80){return{x:t+Math.random()*(this.worldWidth-t*2),y:t+Math.random()*(this.worldHeight-t*2)}}resize(t,e){this.width=t,this.height=e}start(){this.state="playing",this.timer=this.matchDuration,this.tickId=0,this.grid=new N(this.worldWidth,this.worldHeight,50),this.player=new U(this.worldWidth/2,this.worldHeight/2),this.bots=this.createBots(f.botCount),this.expCubes=[],this.relics=[],this.objectiveNode=null,this.objectiveSpawnTimer=f.objectiveInitialDelay,this.objectiveText="OBJECTIVE: LINK SCAN...",this.relicSpawnTimer=f.relicInitialDelay,this.phaseKey="stable",this.dataStormPulseTimer=2.6,this.overdriveCharge=0,this.overdriveMax=f.overdriveMax,this.kills=0,this.nodesCaptured=0,this.pendingPerkChoices=0,this.closePerkSelection(),this.alertText="",this.alertTimer=0,this.effects=new pt,this.audio=new ft,this.timerDisplay&&this.timerDisplay.classList.remove("warning");const t=document.getElementById("level-display");t&&(t.innerText="1");const e=document.getElementById("exp-bar-fill");e&&(e.style.width="0%"),this.updateHUD(0)}get phaseConfig(){return V[this.phaseKey]||V.stable}setAlert(t,e=2){this.alertText=t,this.alertTimer=e}addOverdrive(t,e=!1){const s=e&&this.player?this.player.getOverdriveGainMultiplier():1;this.overdriveCharge=E(this.overdriveCharge+t*s,0,this.overdriveMax)}spawnRelic(){const t=H[Math.floor(Math.random()*H.length)],e=this.randomPoint(200);this.relics.push(new mt(t,e.x,e.y))}applyRelic(t,e){const s=$[e];s&&(t.applyBuff(e,s.duration),t.id===1&&(this.player.addExp(8),this.addOverdrive(f.overdriveRelicGain,!0),this.setAlert(`RELIC ACQUIRED: ${s.label.toUpperCase()}`,1.7)))}spawnObjectiveNode(){const t=this.randomPoint(260);this.objectiveNode={x:t.x,y:t.y,radius:220,timeLeft:f.objectiveDuration,captureGoal:f.objectiveCaptureGoal,progress:{}},this.objectiveText="OBJECTIVE: CAPTURE THE CONTROL NODE"}captureObjective(t){if(!this.objectiveNode)return;const e=this.objectiveNode,s=t===1?560:470;this.grid.paintRadius(e.x,e.y,s,t),this.effects.spawnExplosion(e.x,e.y,t===1?"#00ffff":"#ff00ff"),t===1?(this.nodesCaptured++,this.player.addExp(40),this.addOverdrive(f.overdriveNodeGain,!0),this.audio.playLevelUp(),this.setAlert(`CONTROL NODE CAPTURED (+${Math.round(f.overdriveNodeGain)} OVERDRIVE)`,2.5)):this.setAlert("ENEMY CAPTURED THE CONTROL NODE",2),this.objectiveNode=null,this.objectiveSpawnTimer=f.objectiveRespawnDelay}updateObjective(t){if(!this.objectiveNode){this.objectiveSpawnTimer-=t,this.objectiveSpawnTimer<=0?this.spawnObjectiveNode():this.objectiveText=`OBJECTIVE: NODE IN ${Math.ceil(this.objectiveSpawnTimer)}s`;return}const e=this.objectiveNode;e.timeLeft-=t;const s={},i=[this.player,...this.bots];for(const u of i)if(Math.hypot(u.x-e.x,u.y-e.y)<=e.radius){const m=gt(u.id);s[m]=(s[m]||0)+1}let a=0,r=0,n=0;for(const[u,p]of Object.entries(s))p>r?(n=r,r=p,a=Number(u)):p>n&&(n=p);if(a!==0&&r>n){e.progress[a]=(e.progress[a]||0)+t*f.objectiveCaptureRate*r;for(const u of Object.keys(e.progress))Number(u)!==a&&(e.progress[u]=Math.max(0,e.progress[u]-t*f.objectiveDecayEnemy))}else for(const u of Object.keys(e.progress))e.progress[u]=Math.max(0,e.progress[u]-t*f.objectiveDecayNeutral);let l=0,o=0;for(const[u,p]of Object.entries(e.progress))p>o&&(o=p,l=Number(u));if(l!==0&&o>=e.captureGoal){this.captureObjective(l);return}if(e.timeLeft<=0){this.objectiveNode=null,this.objectiveSpawnTimer=f.objectiveLostRespawnDelay,this.setAlert("CONTROL NODE SIGNAL LOST",1.5),this.objectiveText="OBJECTIVE: NODE SIGNAL LOST";return}const c=E((e.progress[1]||0)/e.captureGoal,0,1);a===1&&r>n?this.objectiveText=`OBJECTIVE: CAPTURING ${Math.round(c*100)}%`:a!==0&&r>n?this.objectiveText=`OBJECTIVE: CONTEST NODE (${Math.ceil(e.timeLeft)}s)`:this.objectiveText=`OBJECTIVE: SECURE NODE (${Math.ceil(e.timeLeft)}s)`}updateRelics(t){const e=t/1e3;this.relicSpawnTimer-=e,this.relicSpawnTimer<=0&&this.relics.length<f.relicMaxOnMap&&(this.spawnRelic(),this.relicSpawnTimer=f.relicRespawnMin+Math.random()*f.relicRespawnRange);const s=[this.player,...this.bots];for(let i=this.relics.length-1;i>=0;i--){const a=this.relics[i],r=a.update(t,s);if(r.collected){this.applyRelic(r.collector,a.type),this.relics.splice(i,1);continue}r.expired&&this.relics.splice(i,1)}}updatePhase(t){if(this.timer<=f.phaseStormAt&&this.phaseKey==="stable"&&(this.phaseKey="storm",this.setAlert("DATA STORM PHASE STARTED",2)),this.timer<=f.phaseOverclockAt&&this.phaseKey!=="overclock"&&(this.phaseKey="overclock",this.effects.triggerShake(24,.3),this.setAlert("OVERCLOCK: SPEED + ATTACK BOOST",2.5)),this.phaseKey==="storm"&&(this.dataStormPulseTimer-=t,this.dataStormPulseTimer<=0)){const e=this.randomPoint(300);this.grid.clearRadius(e.x,e.y,220+Math.random()*60),this.effects.spawnExplosion(e.x,e.y,"#66ccff"),this.dataStormPulseTimer=2.2+Math.random()*1.1}}tryActivateOverdrive(t){if(t.consumeUltimate()){if(this.overdriveCharge<this.overdriveMax){this.setAlert("OVERDRIVE NOT READY",1);return}this.activateOverdrive()}}activateOverdrive(){this.overdriveCharge=0,this.grid.paintRadius(this.player.x,this.player.y,650,1),this.effects.spawnExplosion(this.player.x,this.player.y,"#ffad2f"),this.effects.spawnExplosion(this.player.x,this.player.y,"#00ffff"),this.effects.triggerShake(34,.32),this.effects.triggerHitstop(.06),this.audio.playOverdrive();let t=0;for(const e of this.bots)Math.hypot(e.x-this.player.x,e.y-this.player.y)<=290&&this.defeatEntity(this.player,e,"nova")&&t++;this.player.addExp(30+t*8),t>0?this.setAlert(`PULSE NOVA: ${t} TAKEDOWN`,2.2):this.setAlert("PULSE NOVA DEPLOYED",1.5)}updateHUD(t=0){if(!this.player)return;if(this.timerDisplay&&(this.timerDisplay.innerText=Math.ceil(this.timer),this.timer<=10?this.timerDisplay.classList.add("warning"):this.timerDisplay.classList.remove("warning")),this.dominationDisplay){const a=this.grid.getDomination(1);this.dominationDisplay.innerText=`${a.toFixed(1)}%`}const e=this.phaseConfig;if(this.phaseDisplay&&(this.phaseDisplay.innerText=e.label,this.phaseDisplay.style.borderColor=e.color,this.phaseDisplay.style.color=e.color),this.alertTimer>0&&(this.alertTimer=Math.max(0,this.alertTimer-t)),this.objectiveStatus&&(this.isPerkSelectionOpen?this.objectiveStatus.innerText="指令: パークを選択せよ":this.objectiveStatus.innerText=this.alertTimer>0?this.alertText:this.objectiveText),this.buffStatus){const a=this.player.getBuffSnapshot();this.buffStatus.innerHTML=a.length?a.slice(0,3).map(r=>`<span class="status-badge" style="color:#d4ff68; border-color:rgba(212,255,104,0.4); background:rgba(212,255,104,0.15)">${r.label} ${r.remaining.toFixed(1)}s</span>`).join(""):""}if(this.perkStatus){const a=this.player.getPerkSummary();this.perkStatus.innerHTML=a.length?a.map(r=>`<span class="status-badge" style="color:#ffcf67; border-color:rgba(255,207,103,0.4); background:rgba(255,207,103,0.15)">${r}</span>`).join(""):""}const s=E(this.overdriveCharge/this.overdriveMax*100,0,100);this.overdriveFill&&(this.overdriveFill.style.width=`${s}%`),this.overdriveLabel&&(this.overdriveLabel.innerText=s>=100?"オーバードライブ 発動可能":`オーバードライブ ${Math.floor(s)}%`),this.overdriveHint&&(this.overdriveHint.style.color=s>=100?"#ffd75a":"rgba(255, 255, 255, 0.6)");const i=document.getElementById("ultimate-btn");i&&(s>=100?i.classList.add("ready"):i.classList.remove("ready"))}update(t,e=this.inputFallback){if(this.state!=="playing")return;this.audio.playBGM();const s=t/1e3;if(this.isPerkSelectionOpen){this.updateHUD(0);return}if(this.pendingPerkChoices>0){this.openPerkSelection(),this.updateHUD(0);return}if(this.tickId++,this.effects.update(t)){this.updateHUD(s);return}if(this.timer-=s,this.timer<=0){this.timer=0,this.endGame();return}this.updatePhase(s),this.tryActivateOverdrive(e||this.inputFallback);const a=!!e?.isAttacking,r=e?.getVector?e.getVector():{x:0,y:0};a&&this.player.attackCooldown<=0&&this.audio.playSlash();const n=this.player.level,l=this.phaseConfig,o={speed:l.speed,cooldown:l.cooldown};this.player.update(t,r,a,this.grid,o);for(const p of this.bots)p.update(t,this.grid,this.player,this.bots,this.expCubes,this.relics,this.objectiveNode,o);const c=[this.player,...this.bots];if(this.expCubes=this.expCubes.filter(p=>!p.update(t,c,this.worldWidth,this.worldHeight)),this.updateRelics(t),this.updateObjective(s),this.handleCombat(),this.player.level>n){const p=this.player.level-n;this.audio.playLevelUp(),this.addOverdrive(f.overdriveLevelGain*p,!0),this.pendingPerkChoices+=p,this.openPerkSelection()}this.cameraX=this.player.x-this.width/2,this.cameraY=this.player.y-this.height/2,this.cameraX=Math.max(0,Math.min(this.worldWidth-this.width,this.cameraX)),this.cameraY=Math.max(0,Math.min(this.worldHeight-this.height,this.cameraY));const u=this.effects.getShakeOffset();this.cameraX+=u.x,this.cameraY+=u.y,this.updateDamageWarning(),this.updateHUD(s)}updateDamageWarning(){const t=document.getElementById("damage-vignette");if(!t)return;let e=!1;for(const s of this.bots)if(s.currentTarget&&s.currentTarget.id===1&&Math.hypot(s.x-this.player.x,s.y-this.player.y)<s.attackRadius*1.5+this.player.radius){e=!0;break}e?t.classList.add("active"):t.classList.remove("active")}defeatEntity(t,e,s="combat"){if(e.lastDefeatTick===this.tickId)return!1;if(e.id===1&&typeof e.takeHit=="function"&&!e.takeHit(1)){this.effects.spawnExplosion(e.x,e.y,"#ff6677"),this.effects.triggerShake(14,.14),this.effects.triggerHitstop(.03),this.setAlert(`被弾! 残耐久 ${e.lives}/${e.maxLives}`,1.2),this.player.attackCooldown=0;const n=this.randomPoint(120);return e.x=n.x,e.y=n.y,e.lastDefeatTick=this.tickId,!1}this.logKill(t,e,s);const i=e.level*4+2;for(let r=0;r<i;r++)this.expCubes.push(new ut(e.x,e.y));e.die(),this.grid.paintRadius(e.x,e.y,380+t.level*45,t.id),this.effects.spawnExplosion(e.x,e.y,e.color),(t.id===1||e.id===1)&&(this.effects.triggerShake(20,.18),this.effects.triggerHitstop(t.id===1?.08:.04),this.audio.playKill()),t.id===1&&(this.kills++,this.addOverdrive(s==="nova"?f.overdriveNovaKillGain:f.overdriveKillGain,!0),this.effects.triggerKillStreak()),e.id===1&&(this.player.attackCooldown=0,this.setAlert("機体大破! リスポーン",1.2));const a=this.randomPoint(120);return e.x=a.x,e.y=a.y,e.id===1&&typeof e.restoreLives=="function"&&e.restoreLives(),e.lastDefeatTick=this.tickId,!0}handleCombat(){const t=[this.player,...this.bots];for(const e of t)if(e.justAttacked)for(const s of t){if(e.id===s.id||s.lastDefeatTick===this.tickId)continue;Math.hypot(e.x-s.x,e.y-s.y)<=e.attackRadius+s.radius&&this.defeatEntity(e,s,"combat")}}logKill(t,e,s="combat"){const i=document.getElementById("kill-log");if(!i)return;const a=document.createElement("div");a.className="kill-entry";const r=t.id===1?"あなた":t.name,n=e.id===1?"あなた":e.name,l=s==="nova"?' <span style="color:#ffb347">[ノヴァ]</span>':"";a.innerHTML=`<span style="color:${t.color}">${r}</span> が <span style="color:${e.color}">${n}</span> を撃破${l}`,i.appendChild(a),setTimeout(()=>{i.contains(a)&&i.removeChild(a)},3e3)}drawObjectiveNode(t){if(!this.objectiveNode)return;const e=this.objectiveNode,s=e.x-this.cameraX,i=e.y-this.cameraY,a=E((e.progress[1]||0)/e.captureGoal,0,1);t.save(),t.translate(s,i),t.globalAlpha=.16,t.fillStyle="#8bd8ff",t.beginPath(),t.arc(0,0,e.radius,0,Math.PI*2),t.fill(),t.globalAlpha=.95,t.strokeStyle="#99dfff",t.lineWidth=3,t.beginPath(),t.arc(0,0,e.radius,0,Math.PI*2),t.stroke(),t.strokeStyle="#00ffff",t.lineWidth=7,t.beginPath(),t.arc(0,0,e.radius-12,-Math.PI/2,-Math.PI/2+Math.PI*2*a),t.stroke(),t.fillStyle="#ffffff",t.font="bold 13px Orbitron",t.textAlign="center",t.fillText(`NODE ${Math.ceil(e.timeLeft)}s`,0,6),t.restore()}draw(t){t.fillStyle="#050510",t.fillRect(0,0,this.width,this.height),this.grid.draw(t,this.cameraX,this.cameraY,this.width,this.height),this.drawObjectiveNode(t);for(const e of this.relics)e.draw(t,this.cameraX,this.cameraY);for(const e of this.expCubes)e.draw(t,this.cameraX,this.cameraY);for(const e of this.bots)e.draw(t,this.cameraX,this.cameraY);this.player.draw(t,this.cameraX,this.cameraY),this.effects.draw(t,this.cameraX,this.cameraY),this.phaseKey==="storm"?(t.fillStyle="rgba(130, 220, 255, 0.05)",t.fillRect(0,0,this.width,this.height)):this.phaseKey==="overclock"&&(t.fillStyle="rgba(255, 145, 41, 0.05)",t.fillRect(0,0,this.width,this.height))}endGame(){this.state="result",this.pendingPerkChoices=0,this.closePerkSelection(),this.audio.stopBGM();const t=this.grid.getDomination(1);this.finalDomination.innerText=`${t.toFixed(1)}%`,this.finalKills.innerText=`${this.kills}`;const e=t*2+this.kills*10+this.nodesCaptured*30;let s="C";e>=200?s="S":e>=140?s="A":e>=80&&(s="B"),t>35?(this.resultTitle.innerText="制圧完了",this.resultTitle.style.color="#00ffff",this.resultTitle.style.textShadow="0 0 20px rgba(0, 255, 255, 0.8)"):(this.resultTitle.innerText="撃墜...",this.resultTitle.style.color="#ff00ff",this.resultTitle.style.textShadow="0 0 20px rgba(255, 0, 255, 0.8)");const i=this.kills+this.nodesCaptured*2,a=this.userData.addMatchResult(t,i,this.nodesCaptured);this.lastMatchData={dominationPercent:t,kills:this.kills,nodesCaptured:this.nodesCaptured},this.rewardDisplay.innerHTML=`
            <div class="rank-display rank-${s.toLowerCase()}">${s}</div>
            <p style="color:var(--cyan)">+${a.creditsEarned} クレジット</p>
            <p style="color:#ccff00">+${a.expEarned} メタEXP</p>
            <p style="color:#ffd75a">制御ノード: ${this.nodesCaptured}</p>
        `,this.resultScreen.classList.remove("hidden"),document.getElementById("mobile-controls").classList.add("hidden"),typeof this.onGameEnd=="function"&&this.onGameEnd()}}const B=60,vt=10,bt=90;class kt{constructor(t={}){this.costSingle=vt,this.costMulti=bt,this.progressionApi=t.progressionApi||null}pull(){if(d.getGems()<this.costSingle)return{success:!1,reason:"NOT ENOUGH GEMS"};d.addGems(-this.costSingle,"gacha_pull_single",{cost:this.costSingle});const e={success:!0,results:[this._rollOnce(!1)],pityCounter:d.getPityCounter()};return this._reportPull("single",e.results,this.costSingle,e.pityCounter),e}pullMulti(){if(d.getGems()<this.costMulti)return{success:!1,reason:"NOT ENOUGH GEMS"};d.addGems(-this.costMulti,"gacha_pull_multi",{cost:this.costMulti,pulls:10});const t=[];for(let s=0;s<10;s++){const i=s===9;t.push(this._rollOnce(i))}const e={success:!0,results:t,pityCounter:d.getPityCounter()};return this._reportPull("multi",e.results,this.costMulti,e.pityCounter),e}_rollOnce(t=!1){const e=d.incrementPity();let s=1;if(e>=B)s=this._getSSRId(),d.resetPity();else if(t){const r=R.filter(n=>{const l=v[n.id];return l&&(l.rarity==="SR"||l.rarity==="SSR")});s=this._rollFromTable(r)}else s=this._rollFromTable(R);const i=v[s];if(d.hasCharacter(s)){const r=d.addCharacterDupe(s),n=i.rarity==="SSR"?800:i.rarity==="SR"?400:200;return d.addCredits(n,"gacha_duplicate_credit",{charId:s,rarity:i.rarity}),{character:i,isDuplicate:!0,dupeCount:r,creditsReward:n}}else return d.unlockCharacter(s),i.rarity==="SSR"&&d.resetPity(),{character:i,isDuplicate:!1,dupeCount:0,creditsReward:0}}_rollFromTable(t){const e=t.reduce((a,r)=>a+r.weight,0),s=Math.random()*e;let i=0;for(const a of t)if(i+=a.weight,s<=i)return a.id;return t[t.length-1]?.id||1}_getSSRId(){const t=R.filter(e=>{const s=v[e.id];return s&&s.rarity==="SSR"});return t.length===0?1:t[Math.floor(Math.random()*t.length)].id}getPityInfo(){const t=d.getPityCounter();return{current:t,threshold:B,remaining:B-t}}_reportPull(t,e,s,i){if(!this.progressionApi)return;const a={mode:t,cost:s,pityCounter:i,pulls:e.map(r=>({charId:r.character.id,rarity:r.character.rarity,isDuplicate:!!r.isDuplicate}))};this.progressionApi.submitGachaPull(a)}}const wt=[{day:1,type:"credits",amount:500,label:"500 クレジット"},{day:2,type:"gems",amount:10,label:"10 ジェム"},{day:3,type:"credits",amount:1e3,label:"1000 クレジット"},{day:4,type:"gems",amount:15,label:"15 ジェム"},{day:5,type:"credits",amount:1500,label:"1500 クレジット"},{day:6,type:"gems",amount:25,label:"25 ジェム"},{day:7,type:"gems",amount:80,label:"80 ジェム ★"}];class St{constructor(t={}){this.table=wt,this.clock=t.clock||null,this.progressionApi=t.progressionApi||null}check(){const t=d.getLoginBonus(),e=this._todayString();if(t.lastLoginDate===e)return{shouldShow:!1};const s=this._yesterdayString();let i=t.streak||0;t.lastLoginDate===s?i++:i=1;const a=(i-1)%this.table.length,r=this.table[a];return{shouldShow:!0,dayIndex:a,reward:r,streak:i,totalDays:this.table.length}}claim(){const t=this.check();if(!t.shouldShow)return null;t.reward.type==="credits"?d.addCredits(t.reward.amount,"login_bonus",{day:t.dayIndex+1,streak:t.streak}):t.reward.type==="gems"&&d.addGems(t.reward.amount,"login_bonus",{day:t.dayIndex+1,streak:t.streak});const e=this._todayString();return d.updateLoginBonus({lastLoginDate:e,streak:t.streak}),this.progressionApi&&this.progressionApi.claimLoginBonus({day:t.dayIndex+1,streak:t.streak,date:e,reward:t.reward}),t}getTableForUI(){const s=(d.getLoginBonus().streak||0)%this.table.length;return this.table.map((i,a)=>({...i,status:a<s?"claimed":a===s?"current":"upcoming"}))}_todayString(){return this.clock&&typeof this.clock.todayKey=="function"?this.clock.todayKey():this._dateString(new Date)}_yesterdayString(){return this.clock&&typeof this.clock.dateKeyFromOffset=="function"?this.clock.dateKeyFromOffset(-1):this._dateString(new Date(Date.now()-864e5))}_dateString(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}}const Mt=[{level:1,type:"credits",amount:300,label:"300 クレジット"},{level:2,type:"gems",amount:10,label:"10 ジェム"},{level:3,type:"credits",amount:500,label:"500 クレジット"},{level:4,type:"credits",amount:500,label:"500 クレジット"},{level:5,type:"gems",amount:20,label:"20 ジェム"},{level:6,type:"credits",amount:800,label:"800 クレジット"},{level:7,type:"credits",amount:800,label:"800 クレジット"},{level:8,type:"gems",amount:25,label:"25 ジェム"},{level:9,type:"credits",amount:1e3,label:"1000 クレジット"},{level:10,type:"gems",amount:50,label:"50 ジェム ★"},{level:11,type:"credits",amount:1e3,label:"1000 クレジット"},{level:12,type:"gems",amount:15,label:"15 ジェム"},{level:13,type:"credits",amount:1200,label:"1200 クレジット"},{level:14,type:"credits",amount:1200,label:"1200 クレジット"},{level:15,type:"gems",amount:30,label:"30 ジェム"},{level:16,type:"credits",amount:1500,label:"1500 クレジット"},{level:17,type:"credits",amount:1500,label:"1500 クレジット"},{level:18,type:"gems",amount:35,label:"35 ジェム"},{level:19,type:"credits",amount:2e3,label:"2000 クレジット"},{level:20,type:"gems",amount:80,label:"80 ジェム ★"},{level:21,type:"credits",amount:2e3,label:"2000 クレジット"},{level:22,type:"gems",amount:20,label:"20 ジェム"},{level:23,type:"credits",amount:2500,label:"2500 クレジット"},{level:24,type:"credits",amount:2500,label:"2500 クレジット"},{level:25,type:"gems",amount:40,label:"40 ジェム"},{level:26,type:"credits",amount:3e3,label:"3000 クレジット"},{level:27,type:"credits",amount:3e3,label:"3000 クレジット"},{level:28,type:"gems",amount:50,label:"50 ジェム"},{level:29,type:"credits",amount:5e3,label:"5000 クレジット"},{level:30,type:"gems",amount:150,label:"150 ジェム ★★"}],K=500;class Ct{constructor(t={}){this.rewards=Mt,this.maxLevel=30,this.progressionApi=t.progressionApi||null}getState(){const t=d.getBattlePass();return{level:t.level,exp:t.exp,expNeeded:K,expPercent:t.exp/K*100,claimed:t.claimed||[]}}getRewardsForUI(){const t=this.getState();return this.rewards.map(e=>({...e,unlocked:t.level>=e.level,claimed:t.claimed.includes(e.level),canClaim:t.level>=e.level&&!t.claimed.includes(e.level)}))}claimReward(t){const e=this.getState();if(e.level<t||e.claimed.includes(t))return null;const s=this.rewards.find(i=>i.level===t);return s?(s.type==="credits"?d.addCredits(s.amount,"battlepass_reward",{level:s.level}):s.type==="gems"&&d.addGems(s.amount,"battlepass_reward",{level:s.level}),d.claimBattlePassReward(t),this.progressionApi&&this.progressionApi.claimBattlePassReward(t,{rewardType:s.type,rewardAmount:s.amount}),s):null}getUnclaimedCount(){const t=this.getState();return this.rewards.filter(e=>t.level>=e.level&&!t.claimed.includes(e.level)).length}}const xt=[{id:"welcome",title:"VOID-RUSH へようこそ",text:`60秒の高速テリトリーバトル。
エリアを塗り、敵を倒し、支配率で勝利をつかめ。`,highlight:null},{id:"move",title:"基本操作",text:`WASD/矢印キーで移動。
モバイルは左スティックで操作。`,highlight:null},{id:"attack",title:"戦闘",text:`クリック/スペースで攻撃。
敵を倒してEXPを奪え。`,highlight:null},{id:"overdrive",title:"オーバードライブ",text:`アクションでゲージを溜め、OVERDRIVE発動！
周囲を一掃する強力なパルスノヴァ。`,highlight:null},{id:"gacha",title:"召喚・編成",text:`ガチャでオペレーターを獲得。
編成画面で強化・限界突破しよう。`,highlight:null},{id:"ready",title:"準備完了",text:`出撃して戦場を制圧せよ！
日課の任務をこなして報酬を獲得しよう。`,highlight:null}];class Et{constructor(){this.steps=xt,this.currentStep=0,this.overlay=document.getElementById("tutorial-overlay")}shouldShow(){return!d.isTutorialDone()}show(){!this.overlay||!this.shouldShow()||(this.currentStep=0,this.render(),this.overlay.classList.remove("hidden"))}render(){const t=this.steps[this.currentStep];if(!t||!this.overlay)return;const e=this.currentStep>=this.steps.length-1,s=`${this.currentStep+1} / ${this.steps.length}`;this.overlay.innerHTML=`
            <div class="tutorial-card">
                <div class="tutorial-progress">${s}</div>
                <h2 class="tutorial-title">${t.title}</h2>
                <p class="tutorial-text">${t.text.replace(/\n/g,"<br>")}</p>
                <div class="tutorial-actions">
                    ${this.currentStep>0?'<button id="tut-prev" class="neon-btn tut-btn">◀ 戻る</button>':""}
                    <button id="tut-next" class="neon-btn tut-btn tut-btn-primary">${e?"始める ▶":"次へ ▶"}</button>
                </div>
                <button id="tut-skip" class="tut-skip">スキップ</button>
            </div>
        `,document.getElementById("tut-next").onclick=()=>{e?this.complete():(this.currentStep++,this.render())};const i=document.getElementById("tut-prev");i&&(i.onclick=()=>{this.currentStep--,this.render()}),document.getElementById("tut-skip").onclick=()=>this.complete()}complete(){d.completeTutorial(),this.overlay&&this.overlay.classList.add("hidden")}}class Tt{constructor(t){this.callbacks=t,this.serverClock=t.serverClock||null,this.progressionApi=t.progressionApi||null,this.gachaSystem=new kt({progressionApi:this.progressionApi}),this.loginBonus=new St({clock:this.serverClock,progressionApi:this.progressionApi}),this.battlePass=new Ct({progressionApi:this.progressionApi}),this.tutorial=new Et,this.missionSystem=t.missionSystem||null,this.screen=document.getElementById("home-screen"),this.views={main:document.getElementById("home-view-main"),roster:document.getElementById("home-view-roster"),gacha:document.getElementById("home-view-gacha"),shop:document.getElementById("home-view-shop"),missions:document.getElementById("home-view-missions"),stats:document.getElementById("home-view-stats"),battlepass:document.getElementById("home-view-battlepass")},this.navBtns=document.querySelectorAll(".nav-btn"),this.btnBattle=document.getElementById("btn-battle"),this.btnPull1=document.getElementById("btn-pull-1"),this.btnPull10=document.getElementById("btn-pull-10"),this.gachaOverlay=document.getElementById("gacha-overlay"),this.gachaResultCard=document.getElementById("gacha-result-card"),this.gachaSprite=document.getElementById("gacha-sprite"),this.gachaName=document.getElementById("gacha-name"),this.gachaRarity=document.getElementById("gacha-rarity"),this.gachaDesc=document.getElementById("gacha-desc"),this.gachaDupMsg=document.getElementById("gacha-dup-msg"),this.gachaMultiResults=document.getElementById("gacha-multi-results"),this.btnGachaClose=document.getElementById("btn-gacha-close"),this.pityDisplay=document.getElementById("pity-display"),this.rosterGrid=document.getElementById("roster-grid"),this.shopList=document.getElementById("shop-list"),this.charDetailModal=document.getElementById("char-detail-modal"),this.missionList=document.getElementById("mission-list"),this.statsArea=document.getElementById("stats-content"),this.bpContent=document.getElementById("bp-content"),this.loginBonusModal=document.getElementById("login-bonus-modal"),this.shopConfig=[{id:"hp",name:"装甲強化",desc:"最大HP +1",cost:1500,type:"hp",val:1},{id:"speed",name:"機動加速",desc:"基礎速度 +0.5",cost:2e3,type:"speed",val:.5},{id:"magnet",name:"磁場拡張",desc:"回収範囲 +20",cost:1e3,type:"magnet",val:20}],this.audioCtx=null,this.attachEvents()}playClickSE(){try{this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext));const t=this.audioCtx.createOscillator(),e=this.audioCtx.createGain();t.connect(e),e.connect(this.audioCtx.destination),t.frequency.setValueAtTime(1200,this.audioCtx.currentTime),t.frequency.exponentialRampToValueAtTime(600,this.audioCtx.currentTime+.08),e.gain.setValueAtTime(.15,this.audioCtx.currentTime),e.gain.exponentialRampToValueAtTime(.001,this.audioCtx.currentTime+.08),t.start(),t.stop(this.audioCtx.currentTime+.08)}catch{}}attachEvents(){this.btnBattle&&(this.btnBattle.onclick=()=>{this.playClickSE(),this.hide(),this.callbacks.onStartBattle&&this.callbacks.onStartBattle()}),this.navBtns.forEach(t=>{t.onclick=e=>{this.playClickSE(),this.switchView(e.currentTarget.dataset.target,e.currentTarget)}}),this.btnPull1&&(this.btnPull1.onclick=()=>{this.playClickSE(),this.handlePull(1)}),this.btnPull10&&(this.btnPull10.onclick=()=>{this.playClickSE(),this.handlePull(10)}),this.btnGachaClose&&(this.btnGachaClose.onclick=()=>{this.playClickSE(),this.hideGachaResult()})}show(){this.updateProfile(),this.updateNotificationBadges();const t=Array.from(this.navBtns).find(e=>e.dataset.target==="home-view-main")||null;this.switchView("home-view-main",t),this.screen.classList.remove("hidden"),this.tutorial.shouldShow()?this.tutorial.show():this.checkLoginBonus()}hide(){this.screen.classList.add("hidden")}checkLoginBonus(){const t=this.loginBonus.check();if(!t.shouldShow||!this.loginBonusModal)return;const e=this.loginBonus.getTableForUI(),s=this.loginBonusModal,i=e.map((a,r)=>`
            <div class="lb-day ${a.status}" ${a.status==="current"?'id="lb-current"':""}>
                <div class="lb-day-num">${r+1}日目</div>
                <div class="lb-day-reward">${a.label}</div>
                ${a.status==="claimed"?'<div class="lb-check">✓</div>':""}
            </div>
        `).join("");s.innerHTML=`
            <div class="lb-content">
                <h2 class="lb-title">ログインボーナス</h2>
                <p class="lb-streak">連続ログイン: ${t.streak}日</p>
                <div class="lb-grid">${i}</div>
                <button id="lb-claim-btn" class="neon-btn" style="margin-top:20px; font-size:16px; padding:12px 30px">
                    受け取る: ${t.reward.label}
                </button>
            </div>
        `,s.classList.remove("hidden"),document.getElementById("lb-claim-btn").onclick=()=>{this.playClickSE(),this.loginBonus.claim(),s.classList.add("hidden"),this.updateProfile()}}updateProfile(){const t=d.getLevel(),e=document.getElementById("home-level"),s=document.getElementById("home-credits"),i=document.getElementById("home-gems");e&&(e.innerText=`LV. ${t}`),s&&(s.innerText=d.getCredits()),i&&(i.innerText=d.getGems());const a=d.getSelectedCharacter(),r=v[a],n=d.getCharacterData(a);if(r){const l=document.getElementById("home-main-name");l&&(l.innerText=`${r.name} // LV.${n.level} ★${n.uncap}`);const o=document.getElementById("home-main-sprite");o&&(o.className=`main-character-sprite ${r.spriteClass}`)}}updateNotificationBadges(){if(this.missionSystem){const t=this.missionSystem.getUnclaimedCount(),e=this.battlePass.getUnclaimedCount();this.navBtns.forEach(s=>{const i=s.querySelector(".notif-badge");s.dataset.target==="home-view-missions"&&(t>0&&i?(i.classList.remove("hidden"),i.innerText=t):i&&i.classList.add("hidden")),s.dataset.target==="home-view-battlepass"&&(e>0&&i?(i.classList.remove("hidden"),i.innerText=e):i&&i.classList.add("hidden"))})}}switchView(t,e=null){if(!t)return;Object.values(this.views).forEach(i=>{i&&i.classList.add("hidden")});const s=this.views[t.replace("home-view-","")];s&&s.classList.remove("hidden"),this.navBtns.forEach(i=>i.classList.remove("active")),e&&this.navBtns.forEach(i=>{i.dataset.target===t&&i.classList.add("active")}),this.updateProfile(),t==="home-view-roster"&&this.renderRoster(),t==="home-view-shop"&&this.renderShop(),t==="home-view-gacha"&&this.renderGachaInfo(),t==="home-view-missions"&&this.renderMissions(),t==="home-view-stats"&&this.renderStats(),t==="home-view-battlepass"&&this.renderBattlePass()}renderRoster(){if(!this.rosterGrid)return;this.rosterGrid.innerHTML="";const t=d.getUnlockedCharacters(),e=d.getSelectedCharacter();Object.values(v).sort((i,a)=>{const r=t.includes(i.id),n=t.includes(a.id);return r&&!n?-1:!r&&n?1:i.id-a.id}).forEach(i=>{const a=t.includes(i.id),r=e===i.id,n=d.getCharacterData(i.id),l=document.createElement("div");if(l.className=`roster-card ${r?"active":""}`,l.style.opacity=a?"1":"0.4",l.innerHTML=`
                <div class="mini-sprite ${i.spriteClass}"></div>
                <h3>${i.name}</h3>
                <div style="font-size:10px; color:${i.color}; margin-bottom:4px">${i.rarity}</div>
                ${a?`
                    <div style="font-size:10px; color:#aaa; margin-bottom:6px">LV.${n.level} ★${n.uncap} | 欠片: ${n.dupeCount}</div>
                    <div style="display:flex; gap:6px; justify-content:center; flex-wrap:wrap">
                        <button class="neon-btn roster-select-btn" style="font-size:11px; padding:6px 10px" ${r?"disabled":""}>${r?"装備中":"選択"}</button>
                        <button class="neon-btn roster-detail-btn" style="font-size:11px; padding:6px 10px; border-color:#ffdd66; color:#ffdd66">詳細</button>
                    </div>
                `:'<div style="font-size:12px; color:#666">未解放</div>'}
            `,a){const o=l.querySelector(".roster-select-btn");o&&!r&&(o.onclick=u=>{u.stopPropagation(),this.playClickSE(),d.setSelectedCharacter(i.id),this.renderRoster(),this.updateProfile()});const c=l.querySelector(".roster-detail-btn");c&&(c.onclick=u=>{u.stopPropagation(),this.playClickSE(),this.showCharDetail(i.id)})}this.rosterGrid.appendChild(l)})}showCharDetail(t){if(!this.charDetailModal)return;const e=v[t];if(!e)return;const s=d.getCharacterData(t),i=Z(t,s.level,s.uncap),a=lt(t,s.level),r=(s.uncap+1)*2,n=d.getCredits()>=a,l=s.dupeCount>=r&&s.uncap<5;this.charDetailModal.innerHTML=`
            <div class="cd-content">
                <div class="cd-header">
                    <div class="mini-sprite ${e.spriteClass}" style="width:80px;height:80px"></div>
                    <div>
                        <h2 style="color:${e.color}">${e.name}</h2>
                        <div style="font-size:12px; color:#aaa">${e.rarity} | LV.${s.level} | ★${s.uncap}</div>
                        <div style="font-size:11px; color:#888; margin-top:4px">${e.description}</div>
                    </div>
                </div>
                <div class="cd-stats">
                    <div class="cd-stat"><span>速度</span><span>${i.speed.toFixed(1)}</span></div>
                    <div class="cd-stat"><span>攻撃範囲</span><span>${i.attackRadius.toFixed(1)}</span></div>
                    <div class="cd-stat"><span>最大HP</span><span>${i.maxHp}</span></div>
                    <div class="cd-stat"><span>斬撃数</span><span>${i.slashes}</span></div>
                </div>
                <div class="cd-actions">
                    <button id="cd-levelup" class="neon-btn" style="font-size:14px; padding:10px 20px" ${n?"":'disabled style="opacity:0.5; font-size:14px; padding:10px 20px"'}>
                        強化: ${a}C
                    </button>
                    <button id="cd-uncap" class="neon-btn" style="font-size:14px; padding:10px 20px; border-color:#ffdd66; color:#ffdd66" ${l?"":'disabled style="opacity:0.5; font-size:14px; padding:10px 20px; border-color:#ffdd66; color:#ffdd66"'}>
                        限界突破 ★${s.uncap+1}: 欠片${r}個 ${s.uncap>=5?"(最大)":""}
                    </button>
                </div>
                <div style="font-size:11px; color:#888; text-align:center; margin-top:8px">
                    所持欠片: ${s.dupeCount} | 突破に必要: ${r}
                </div>
                <button id="cd-close" class="neon-btn" style="margin-top:15px; font-size:12px; padding:8px 20px">閉じる</button>
            </div>
        `,this.charDetailModal.classList.remove("hidden"),document.getElementById("cd-close").onclick=()=>{this.playClickSE(),this.charDetailModal.classList.add("hidden"),this.renderRoster(),this.updateProfile()};const o=document.getElementById("cd-levelup");o&&n&&(o.onclick=()=>{this.playClickSE(),d.levelUpCharacter(t,a),this.showCharDetail(t)});const c=document.getElementById("cd-uncap");c&&l&&(c.onclick=()=>{this.playClickSE(),d.uncapCharacter(t),this.showCharDetail(t)})}renderShop(){this.shopList&&(this.shopList.innerHTML="",this.shopConfig.forEach(t=>{const e=d.getUpgrades()[t.id]||0,s=t.cost+e*500,i=document.createElement("div");i.className="shop-item",i.innerHTML=`
                <div class="shop-item-info">
                    <h3>${t.name} <span style="font-size:12px; color:#fff">LV.${e}</span></h3>
                    <p>${t.desc} (現在: +${t.val*e})</p>
                </div>
                <button class="shop-buy-btn" ${d.getCredits()<s?'disabled style="opacity:0.5"':""}>
                    強化: ${s}C
                </button>
            `;const a=i.querySelector("button");d.getCredits()>=s&&(a.onclick=()=>{this.playClickSE(),d.addCredits(-s,"shop_upgrade",{upgradeId:t.id,level:e+1}),d.buyUpgrade(t.id),this.renderShop(),this.updateProfile()}),this.shopList.appendChild(i)}))}renderGachaInfo(){if(this.pityDisplay){const t=this.gachaSystem.getPityInfo();this.pityDisplay.innerHTML=`
                <div class="pity-bar-container">
                    <div class="pity-bar-fill" style="width:${t.current/t.threshold*100}%"></div>
                </div>
                <span class="pity-text">天井: ${t.current}/${t.threshold} (SSR確定)</span>
            `}}handlePull(t){let e;if(t===10?e=this.gachaSystem.pullMulti():e=this.gachaSystem.pull(),!e.success){alert("ジェムが不足しています！");return}this.updateProfile(),this.renderGachaInfo(),t===10&&e.results.length>1?this.playMultiGachaAnimation(e.results):this.playSingleGachaAnimation(e.results[0])}playSingleGachaAnimation(t){if(!this.gachaOverlay||!this.gachaResultCard||!this.btnGachaClose)return;this.gachaOverlay.classList.remove("hidden"),this.gachaResultCard.classList.add("hidden"),this.gachaMultiResults&&this.gachaMultiResults.classList.add("hidden"),this.btnGachaClose.classList.add("hidden");const e=this.gachaOverlay.querySelector(".portal-ring");e.style.animation="none",e.offsetHeight,e.style.animation="portal-spin 2s linear infinite, portal-expand 2s ease-in forwards",setTimeout(()=>{this.showSingleResult(t)},2e3)}showSingleResult(t){if(!this.gachaSprite||!this.gachaName||!this.gachaRarity||!this.gachaDesc||!this.gachaDupMsg||!this.gachaResultCard||!this.btnGachaClose)return;const e=t.character;this.gachaSprite.className=`char-sprite ${e.spriteClass}`,this.gachaName.innerText=e.name,this.gachaName.style.color=e.color,this.gachaRarity.innerText=e.rarity,this.gachaDesc.innerText=e.description,t.isDuplicate?(this.gachaDupMsg.classList.remove("hidden"),this.gachaDupMsg.innerText=`重複 → 欠片+1 | +${t.creditsReward}C`):this.gachaDupMsg.classList.add("hidden"),this.gachaResultCard.classList.remove("hidden"),this.btnGachaClose.classList.remove("hidden")}playMultiGachaAnimation(t){if(!this.gachaOverlay||!this.btnGachaClose)return;this.gachaOverlay.classList.remove("hidden"),this.gachaResultCard&&this.gachaResultCard.classList.add("hidden"),this.btnGachaClose.classList.add("hidden");const e=this.gachaOverlay.querySelector(".portal-ring");e.style.animation="none",e.offsetHeight,e.style.animation="portal-spin 2s linear infinite, portal-expand 2s ease-in forwards",setTimeout(()=>{this.showMultiResults(t)},2e3)}showMultiResults(t){if(!this.gachaMultiResults)return;this.gachaResultCard&&this.gachaResultCard.classList.add("hidden");const e=t.map(s=>`
            <div class="gacha-multi-card">
                <div class="mini-sprite ${s.character.spriteClass}"></div>
                <div class="gacha-multi-name" style="color:${s.character.color}">${s.character.name}</div>
                <div class="gacha-multi-rarity">${s.character.rarity}</div>
                ${s.isDuplicate?`<div class="gacha-multi-dupe">重複 +${s.creditsReward}C</div>`:'<div class="gacha-multi-new">NEW!</div>'}
            </div>
        `).join("");this.gachaMultiResults.innerHTML=e,this.gachaMultiResults.classList.remove("hidden"),this.btnGachaClose.classList.remove("hidden")}hideGachaResult(){this.gachaOverlay&&this.gachaOverlay.classList.add("hidden"),this.gachaMultiResults&&this.gachaMultiResults.classList.add("hidden"),this.updateProfile(),this.renderGachaInfo()}renderMissions(){if(!this.missionList||!this.missionSystem)return;this.missionList.innerHTML="";const t=this.missionSystem.getDailyMissions();if(t.length===0){this.missionList.innerHTML='<div style="color:#666; text-align:center; padding:40px">本日の任務はありません</div>';return}t.forEach(e=>{const s=Math.min(e.progress,e.target),i=s/e.target*100,a=document.createElement("div");if(a.className=`mission-item ${e.claimed?"claimed":e.completed?"completed":""}`,a.innerHTML=`
                <div class="mission-info">
                    <h3>${e.label}</h3>
                    <p>${e.desc}</p>
                    <div class="mission-progress-bar">
                        <div class="mission-progress-fill" style="width:${i}%"></div>
                    </div>
                    <div class="mission-progress-text">${s}/${e.target}</div>
                </div>
                <div class="mission-reward">
                    <span class="mission-reward-amount">${e.rewardAmount} ${e.rewardType==="gems"?"💎":"C"}</span>
                    ${e.claimed?'<span class="mission-claimed-tag">受取済</span>':e.completed?'<button class="mission-claim-btn">受け取る</button>':""}
                </div>
            `,e.completed&&!e.claimed){const r=a.querySelector(".mission-claim-btn");r&&(r.onclick=()=>{this.playClickSE(),this.missionSystem.claimReward(e.id),this.renderMissions(),this.updateProfile(),this.updateNotificationBadges()})}this.missionList.appendChild(a)})}renderStats(){if(!this.statsArea)return;const t=d.getStats(),e=d.getEconomyLedger(20),s=e.filter(n=>n.category==="credits").reduce((n,l)=>n+(l.amount||0),0),i=e.filter(n=>n.category==="gems").reduce((n,l)=>n+(l.amount||0),0),a=t.totalMatches>0?(t.winCount/t.totalMatches*100).toFixed(1):"0.0",r=e.slice(0,8).map(n=>{const o=`${n.amount>=0?"+":""}${n.amount}`,c=n.source||"unknown";return`
                <div class="economy-row">
                    <span class="economy-category">${n.category}</span>
                    <span class="economy-source">${c}</span>
                    <span class="economy-amount ${n.amount>=0?"plus":"minus"}">${o}</span>
                </div>
            `}).join("");this.statsArea.innerHTML=`
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${t.totalMatches}</div>
                    <div class="stat-label">総出撃数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${t.totalKills}</div>
                    <div class="stat-label">総撃破数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${t.bestDomination.toFixed(1)}%</div>
                    <div class="stat-label">最高支配率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${a}%</div>
                    <div class="stat-label">勝率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${t.bestKills}</div>
                    <div class="stat-label">最多撃破</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${t.totalNodesCaptured}</div>
                    <div class="stat-label">ノード占拠数</div>
                </div>
            </div>
            <div class="economy-summary">
                <div class="economy-head">経済サマリ (直近20イベント)</div>
                <div class="economy-totals">
                    <span>Credits: <b class="${s>=0?"plus":"minus"}">${s>=0?"+":""}${s}</b></span>
                    <span>Gems: <b class="${i>=0?"plus":"minus"}">${i>=0?"+":""}${i}</b></span>
                </div>
                <div class="economy-list">
                    ${r||'<div class="economy-empty">ログなし</div>'}
                </div>
            </div>
        `}renderBattlePass(){if(!this.bpContent)return;const t=this.battlePass.getState(),s=this.battlePass.getRewardsForUI().map(i=>`
            <div class="bp-reward ${i.claimed?"bp-claimed":i.canClaim?"bp-claimable":i.unlocked?"bp-unlocked":"bp-locked"}">
                <div class="bp-level">LV.${i.level}</div>
                <div class="bp-reward-label">${i.label}</div>
                ${i.claimed?'<div class="bp-check">✓</div>':i.canClaim?`<button class="bp-claim-btn" data-level="${i.level}">受取</button>`:""}
            </div>
        `).join("");this.bpContent.innerHTML=`
            <div class="bp-header">
                <div class="bp-level-display">パスLV. ${t.level} / 30</div>
                <div class="bp-exp-bar">
                    <div class="bp-exp-fill" style="width:${t.expPercent}%"></div>
                </div>
                <div class="bp-exp-text">EXP: ${t.exp} / ${t.expNeeded}</div>
            </div>
            <div class="bp-rewards-grid">${s}</div>
        `,this.bpContent.querySelectorAll(".bp-claim-btn").forEach(i=>{i.onclick=()=>{this.playClickSE();const a=parseInt(i.dataset.level);this.battlePass.claimReward(a),this.renderBattlePass(),this.updateProfile(),this.updateNotificationBadges()}})}}class Pt{constructor(){this.keys={},this.joystick={x:0,y:0},this.isAttacking=!1,this.ultimateQueued=!1,window.addEventListener("keydown",n=>{const l=n.key.toLowerCase();this.keys[l]=!0,n.key===" "&&(this.isAttacking=!0),l==="q"&&!n.repeat&&(this.ultimateQueued=!0)}),window.addEventListener("keyup",n=>{this.keys[n.key.toLowerCase()]=!1,n.key===" "&&(this.isAttacking=!1)}),window.addEventListener("mousedown",n=>{n.target.tagName!=="BUTTON"&&(this.isAttacking=!0)}),window.addEventListener("mouseup",()=>{this.isAttacking=!1});const t=document.getElementById("joystick-zone"),e=document.getElementById("attack-btn"),s=document.getElementById("ultimate-btn");let i={x:0,y:0},a=null;t.addEventListener("touchstart",n=>{n.preventDefault();const l=n.changedTouches[0];a=l.identifier;const o=t.getBoundingClientRect();i={x:o.left+o.width/2,y:o.top+o.height/2},this.updateJoystick(l.clientX,l.clientY,i,o.width/2)},{passive:!1}),t.addEventListener("touchmove",n=>{n.preventDefault();for(let l=0;l<n.changedTouches.length;l++)if(n.changedTouches[l].identifier===a){const o=n.changedTouches[l],c=t.getBoundingClientRect();this.updateJoystick(o.clientX,o.clientY,i,c.width/2)}},{passive:!1});const r=n=>{for(let l=0;l<n.changedTouches.length;l++)n.changedTouches[l].identifier===a&&(a=null,this.joystick={x:0,y:0})};t.addEventListener("touchend",r),t.addEventListener("touchcancel",r),e.addEventListener("touchstart",n=>{n.preventDefault(),this.isAttacking=!0},{passive:!1}),e.addEventListener("touchend",n=>{n.preventDefault(),this.isAttacking=!1},{passive:!1}),s&&(s.addEventListener("touchstart",n=>{n.preventDefault(),this.ultimateQueued=!0},{passive:!1}),s.addEventListener("mousedown",n=>{n.preventDefault(),this.ultimateQueued=!0}))}updateJoystick(t,e,s,i){let a=t-s.x,r=e-s.y;const n=Math.hypot(a,r);if(n>0){const l=Math.min(n,i)/i;this.joystick={x:a/n*l,y:r/n*l}}else this.joystick={x:0,y:0}}getVector(){let t=0,e=0;if((this.keys.w||this.keys.arrowup)&&(e-=1),(this.keys.s||this.keys.arrowdown)&&(e+=1),(this.keys.a||this.keys.arrowleft)&&(t-=1),(this.keys.d||this.keys.arrowright)&&(t+=1),t!==0||e!==0){const s=Math.hypot(t,e);return{x:t/s,y:e/s}}return{x:this.joystick.x,y:this.joystick.y}}consumeUltimate(){return this.ultimateQueued?(this.ultimateQueued=!1,!0):!1}}const Dt=[{id:"play_3",label:"3回出撃せよ",desc:"マッチを3回プレイする",type:"matches",target:3,rewardType:"credits",rewardAmount:800},{id:"kill_10",label:"敵を10体撃破せよ",desc:"合計10体の敵を倒す",type:"kills",target:10,rewardType:"credits",rewardAmount:600},{id:"dom_50",label:"支配率50%超え",desc:"1マッチで支配率50%以上を達成",type:"bestDomination",target:50,rewardType:"gems",rewardAmount:15},{id:"kill_5_1",label:"1戦で5体撃破",desc:"1マッチで5体以上撃破する",type:"bestKillsSingle",target:5,rewardType:"gems",rewardAmount:10},{id:"node_2",label:"ノードを2つ占拠",desc:"制御ノードを2つ確保する",type:"nodes",target:2,rewardType:"credits",rewardAmount:500},{id:"win_1",label:"勝利を収めよ",desc:"勝利する（支配率35%以上）",type:"wins",target:1,rewardType:"gems",rewardAmount:20}],At=3;class Rt{constructor(t={}){this.definitions=Dt,this.clock=t.clock||null,this.progressionApi=t.progressionApi||null,this._ensureDailyReset()}_todayString(){if(this.clock&&typeof this.clock.todayKey=="function")return this.clock.todayKey();const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}_ensureDailyReset(){const t=d.getMissions(),e=this._todayString();if(t.lastResetDate!==e){const s=[...this.definitions],i=[];for(let a=0;a<At&&s.length>0;a++){const r=Math.floor(Math.random()*s.length),n=s.splice(r,1)[0];i.push({id:n.id,progress:0,claimed:!1})}d.updateMissions({daily:i,lastResetDate:e})}}getDailyMissions(){return this._ensureDailyReset(),d.getMissions().daily.map(e=>{const s=this.definitions.find(i=>i.id===e.id);return s?{...s,progress:e.progress,claimed:e.claimed,completed:e.progress>=s.target}:null}).filter(Boolean)}feedMatchResult(t){this._ensureDailyReset();const e=d.getMissions();let s=!1;for(const i of e.daily){if(i.claimed)continue;const a=this.definitions.find(r=>r.id===i.id);if(a)switch(a.type){case"matches":i.progress++,s=!0;break;case"kills":i.progress+=t.kills||0,s=!0;break;case"bestDomination":i.progress=Math.max(i.progress,t.dominationPercent||0),s=!0;break;case"bestKillsSingle":i.progress=Math.max(i.progress,t.kills||0),s=!0;break;case"nodes":i.progress+=t.nodesCaptured||0,s=!0;break;case"wins":(t.dominationPercent||0)>35&&(i.progress++,s=!0);break}}return s&&d.updateMissions(e),this.getDailyMissions()}claimReward(t){const e=d.getMissions(),s=e.daily.find(a=>a.id===t);if(!s||s.claimed)return null;const i=this.definitions.find(a=>a.id===t);return!i||s.progress<i.target?null:(s.claimed=!0,i.rewardType==="credits"?d.addCredits(i.rewardAmount,"mission_reward",{missionId:i.id}):i.rewardType==="gems"&&d.addGems(i.rewardAmount,"mission_reward",{missionId:i.id}),d.updateMissions(e),this.progressionApi&&this.progressionApi.claimMissionReward(i.id,{progress:s.progress,target:i.target,rewardType:i.rewardType,rewardAmount:i.rewardAmount}),{rewardType:i.rewardType,rewardAmount:i.rewardAmount})}getUnclaimedCount(){return this.getDailyMissions().filter(e=>e.completed&&!e.claimed).length}}const Bt=5e3;function Lt(h){return!h||typeof h!="string"?"":h.replace(/\/+$/,"")}function F(h){return/^https?:\/\//i.test(h)}function q(h,t){const e=h.endsWith("/")?h.slice(0,-1):h,s=t.startsWith("/")?t:`/${t}`;return`${e}${s}`}class M extends Error{constructor(t,e={}){super(t),this.name="ApiError",this.status=e.status||0,this.url=e.url||"",this.payload=e.payload}}class It{constructor(t={}){this.baseUrl=Lt(t.baseUrl??"/api/voidrush"),this.timeoutMs=Number(t.timeoutMs||Bt),this.defaultHeaders={...t.defaultHeaders||{}}}isEnabled(){return!!this.baseUrl}buildUrl(t,e=null){let s;if(F(t))s=new URL(t);else{if(!this.baseUrl)throw new M("API base URL is not configured");const i=t.startsWith("/")?t:`/${t}`;if(F(this.baseUrl))s=new URL(q(this.baseUrl,i));else{const a=typeof window<"u"?window.location.origin:"http://localhost",r=this.baseUrl.startsWith("/")?this.baseUrl:`/${this.baseUrl}`;s=new URL(q(r,i),a)}}return e&&typeof e=="object"&&Object.entries(e).forEach(([i,a])=>{a!=null&&s.searchParams.set(i,String(a))}),s.toString()}async request(t,e={}){const{method:s="GET",headers:i={},query:a=null,body:r,timeoutMs:n=this.timeoutMs,signal:l}=e,o=this.buildUrl(t,a),c=new AbortController,u=setTimeout(()=>c.abort(),n);l&&l.addEventListener("abort",()=>c.abort(),{once:!0});const p={...this.defaultHeaders,...i},m={method:s,headers:p,signal:c.signal};r!==void 0&&(r instanceof FormData?(delete m.headers["Content-Type"],m.body=r):(Object.keys(m.headers).some(g=>g.toLowerCase()==="content-type")||(m.headers["Content-Type"]="application/json"),m.body=typeof r=="string"?r:JSON.stringify(r)));try{const g=await fetch(o,m),w=await g.text();let x=null;if(w)try{x=JSON.parse(w)}catch{x={raw:w}}if(!g.ok)throw new M(`API request failed: ${g.status}`,{status:g.status,url:o,payload:x});return x}catch(g){throw g instanceof M?g:g?.name==="AbortError"?new M(`API request timeout (${n}ms)`,{url:o}):new M(g?.message||"Network error",{url:o})}finally{clearTimeout(u)}}get(t,e={}){return this.request(t,{...e,method:"GET"})}post(t,e={}){return this.request(t,{...e,method:"POST"})}put(t,e={}){return this.request(t,{...e,method:"PUT"})}delete(t,e={}){return this.request(t,{...e,method:"DELETE"})}}const Ot="voidRushSessionV1";function $t(h){if(!h)return null;try{return JSON.parse(h)}catch{return null}}function Y(h){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return`${h}_${crypto.randomUUID()}`;const t=Math.random().toString(36).slice(2,10);return`${h}_${Date.now().toString(36)}_${t}`}class Nt{constructor(t={}){this.storageKey=t.storageKey||Ot}load(){return $t(localStorage.getItem(this.storageKey))}save(t){return localStorage.setItem(this.storageKey,JSON.stringify(t)),t}create(){const t=new Date().toISOString();return{playerId:Y("player"),sessionId:Y("session"),createdAt:t,lastSeenAt:t}}touch(){const t=this.load(),e=t&&t.playerId&&t.sessionId?{...t,lastSeenAt:new Date().toISOString()}:this.create();return this.save(e)}getSession(){return this.touch()}getAuthHeaders(){const t=this.getSession();return{"x-player-id":t.playerId,"x-session-id":t.sessionId}}}const _t=1440*60*1e3;function W(h){return`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}-${String(h.getDate()).padStart(2,"0")}`}function Ut(h){if(!h)return NaN;const t=[h.epochMs,h.serverEpochMs,h.nowMs,h.timestamp,h.unixMs];for(const s of t){const i=Number(s);if(Number.isFinite(i)&&i>0)return i}const e=Number(h.unix||h.unixSeconds);if(Number.isFinite(e)&&e>0)return e*1e3;if(typeof h.iso=="string"){const s=Date.parse(h.iso);if(!Number.isNaN(s))return s}return NaN}class Gt{constructor(t={}){this.apiClient=t.apiClient||null,this.endpoint=t.endpoint||"/time",this.offsetMs=0,this.lastSyncAt=0,this.source="local",this.lastSyncError=null}async sync(){if(!this.apiClient||!this.apiClient.isEnabled())return this.source="local",this.lastSyncAt=Date.now(),this.lastSyncError="API disabled",this.getStatus();const t=Date.now();try{const e=await this.apiClient.get(this.endpoint),s=Date.now(),i=Ut(e);if(!Number.isFinite(i))throw new Error("Invalid /time payload");const a=t+(s-t)/2;return this.offsetMs=Math.round(i-a),this.lastSyncAt=s,this.lastSyncError=null,this.source="server",this.getStatus()}catch(e){return this.lastSyncAt=Date.now(),this.lastSyncError=e?.message||"Clock sync failed",this.source="local",this.offsetMs=0,this.getStatus()}}nowMs(){return Date.now()+this.offsetMs}nowDate(){return new Date(this.nowMs())}todayKey(){return W(this.nowDate())}dateKeyFromOffset(t=0){return W(new Date(this.nowMs()+t*_t))}getStatus(){return{source:this.source,offsetMs:this.offsetMs,lastSyncAt:this.lastSyncAt,lastSyncError:this.lastSyncError}}}function X(h){return h?typeof h=="string"?h:h.message||"Unknown error":"Unknown error"}function jt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}_${Math.random().toString(36).slice(2,10)}`}const st="voidRushApiQueueV1",Ht=2e3,Vt=300*1e3;function zt(h){if(!h)return[];try{const t=JSON.parse(h);return Array.isArray(t)?t:[]}catch{return[]}}function L(){return zt(localStorage.getItem(st))}function J(h){localStorage.setItem(st,JSON.stringify(h))}function Kt(h,t){const e=Date.now();return{id:`${e}_${Math.random().toString(36).slice(2,10)}`,path:h,envelope:t,attempts:0,nextRetryAt:e,createdAt:e}}function Ft(h){const t=Math.min(Vt,Ht*2**h);return Date.now()+t}class qt{constructor(t={}){this.apiClient=t.apiClient||null,this.sessionService=t.sessionService||null,this.onSnapshot=t.onSnapshot||null,this.flushInFlight=!1}isEnabled(){return!!(this.apiClient&&this.apiClient.isEnabled())}_buildHeaders(t={}){return{...this.sessionService?this.sessionService.getAuthHeaders():{},...t}}_buildEnvelope(t={},e=null){return{requestId:e||jt(),clientSentAt:new Date().toISOString(),payload:t}}_consumeSnapshot(t){const e=t?.snapshot;if(e&&typeof this.onSnapshot=="function")try{this.onSnapshot(e,t)}catch(s){console.warn("Failed to consume server snapshot:",s)}}async _post(t,e={}){if(!this.isEnabled())return{ok:!1,skipped:!0,reason:"api_disabled"};await this.flushQueue(5);const s=this._buildEnvelope(e);try{const i=await this.apiClient.post(t,{headers:this._buildHeaders(),body:s});return this._consumeSnapshot(i),{ok:!0,data:i}}catch(i){return this.enqueue(t,s),{ok:!1,queued:!0,error:X(i)}}}async _get(t,e={}){if(!this.isEnabled())return{ok:!1,skipped:!0,reason:"api_disabled"};try{const s=await this.apiClient.get(t,{headers:this._buildHeaders(),query:e});return this._consumeSnapshot(s),{ok:!0,data:s}}catch(s){return{ok:!1,error:X(s)}}}syncDailyState(){return this._get("/progression/daily")}submitMatchResult(t){return this._post("/progression/match-result",{matchData:t})}submitBattlePassExp(t,e={}){return this._post("/progression/battlepass/exp",{amount:t,meta:e})}claimMissionReward(t,e={}){return this._post("/progression/missions/claim",{missionId:t,context:e})}claimLoginBonus(t={}){return this._post("/progression/login-bonus/claim",t)}claimBattlePassReward(t,e={}){return this._post("/progression/battlepass/claim",{level:t,context:e})}submitGachaPull(t={}){return this._post("/progression/gacha/pull",t)}fetchSnapshot(){return this._get("/progression/snapshot")}uploadSnapshot(t,e="bootstrap"){return this._post("/progression/snapshot",{snapshot:t,reason:e})}fetchLeaderboard(t=20){return this._get("/progression/leaderboard",{limit:t})}enqueue(t,e){const s=L();s.push(Kt(t,e));const i=s.slice(-200);return J(i),i.length}getQueueSize(){return L().length}async flushQueue(t=20){if(!this.isEnabled()||this.flushInFlight)return{ok:!1,skipped:!0};this.flushInFlight=!0;try{const e=L();if(e.length===0)return{ok:!0,sent:0,remaining:0};const s=Date.now(),i=[...e].sort((n,l)=>n.createdAt-l.createdAt);let a=0;const r=[];for(const n of i){if(a>=t){r.push(n);continue}if(Number(n.nextRetryAt||0)>s){r.push(n);continue}try{const l=n.envelope||this._buildEnvelope(n.payload||{}),o=await this.apiClient.post(n.path,{headers:this._buildHeaders(),body:l});this._consumeSnapshot(o),a++}catch{const l=Number(n.attempts||0)+1;r.push({...n,attempts:l,nextRetryAt:Ft(l)})}}return J(r),{ok:!0,sent:a,remaining:r.length}}finally{this.flushInFlight=!1}}}const k=document.getElementById("game-canvas"),P=k.getContext("2d"),it=document.getElementById("ui-layer"),at=document.getElementById("result-screen"),Q=document.getElementById("rematch-btn");let y,rt,I=0,S,C,O,b,T;function nt(){k.width=window.innerWidth,k.height=window.innerHeight,y&&y.resize(k.width,k.height)}window.addEventListener("resize",nt);nt();function ot(h){const t=h-I;I=h,y&&y.state==="playing"?(y.update(t,rt),y.draw(P)):y&&y.state==="result"&&y.draw(P),C=requestAnimationFrame(ot)}function Yt(){cancelAnimationFrame(C),S.hide(),it.classList.remove("hidden"),at.classList.add("hidden"),"ontouchstart"in window||navigator.maxTouchPoints>0?document.getElementById("mobile-controls").classList.remove("hidden"):document.getElementById("mobile-controls").classList.add("hidden"),y=new yt(k.width,k.height),y.onGameEnd=()=>{y.lastMatchData&&(O.feedMatchResult(y.lastMatchData),b?.submitMatchResult(y.lastMatchData)),d.addBattlePassExp(150,"match_clear",y.lastMatchData||{}),b?.submitBattlePassExp(150,y.lastMatchData||{})},y.start(),I=performance.now(),C=requestAnimationFrame(ot)}function Wt(){cancelAnimationFrame(C),C=null,at.classList.add("hidden"),it.classList.add("hidden"),document.getElementById("mobile-controls").classList.add("hidden"),y=null,S.show()}async function Xt(){P.fillStyle="#050510",P.fillRect(0,0,k.width,k.height);const h=new Nt;h.touch();const t=new It;b=new qt({apiClient:t,sessionService:h,onSnapshot:i=>{d.applyServerSnapshot(i)&&S&&(S.updateProfile(),S.updateNotificationBadges())}}),window.addEventListener("online",()=>{b.flushQueue()}),b.flushQueue(),T=new Gt({apiClient:t});const e=await T.sync();e.source!=="server"&&console.info(`Server clock sync unavailable. Falling back to local time. reason=${e.lastSyncError||"unknown"}`);const s=await b.fetchSnapshot();s.ok&&s.data?.hasProfile===!1&&await b.uploadSnapshot(d.exportSnapshot(),"bootstrap_from_local"),O=new Rt({clock:T,progressionApi:b}),S=new Tt({onStartBattle:()=>Yt(),missionSystem:O,serverClock:T,progressionApi:b}),rt=new Pt,Q&&Q.addEventListener("click",Wt),S.show()}window.onload=()=>{Xt().catch(h=>{console.error("Initialization failed:",h)})};
