---
import '@/styles/global.css';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { canonicalUrl, config, ogImageUrl } from '@/config';

type Props = {
  title: string;
  description: string;
};

const { title, description } = Astro.props;
const canonical = canonicalUrl(Astro.url.pathname);
const ogImage = ogImageUrl();
---
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <meta property="og:site_name" content={config.site.name} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <title>{title}</title>
    {config.analytics.enabled && config.analytics.snippet ? (
      <Fragment set:html={config.analytics.snippet} />
    ) : null}
  </head>
  <body>
    <a class="skip-link" href="#main">本文へスキップ</a>
    <Header />
    <main id="main">
      <slot />
    </main>
    <Footer />
    <script is:inline>
      (() => {
        if (!('serviceWorker' in navigator)) return;
        const storageKey = 'aiyume_sw_cleanup_v1';

        navigator.serviceWorker
          .getRegistrations()
          .then(async (registrations) => {
            let removed = false;
            await Promise.all(
              registrations.map(async (registration) => {
                const scopePath = new URL(registration.scope).pathname;
                const isEnglishScope =
                  scopePath === '/aiyume_english' || scopePath.startsWith('/aiyume_english/');
                if (isEnglishScope) return;
                const result = await registration.unregister();
                if (result) removed = true;
              })
            );

            if (removed && navigator.serviceWorker.controller && !sessionStorage.getItem(storageKey)) {
              sessionStorage.setItem(storageKey, '1');
              window.location.reload();
            }
          })
          .catch(() => {});
      })();
    </script>
  </body>
</html>
